---
layout: post
title:  "Linux Kernel の net/socket.c の __sys_recvmmsg 関数における任意のコードを実行される脆弱性"
date:   2016-10-13 18:00:00 +0900
categories: vlunerability
toc: true
---

# CVE-2016-7117

## 概要

Linux Kernel Version 4.5.2未満の net/socket.c の __sys_recvmmsg 関数には、解放済みメモリの使用 (Use-after-free) により、任意のコードを実行される脆弱性が存在します。
第三者により、エラープロセス中に誤って処理される recvmmsg システムコールに関する問題によって、任意のコードを実行される可能性があります。

## CVSS v3

|CVSS v3 Base Score|9.8 Critical|
|Vector|CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H|
|Impact Score| 5.9|
|Exploitability Score| 3.9|
|Attack Vector (AV)| Network|
|Attack Complexity (AC)| Low|
|Privileges Required (PR)| None|
|User Interaction (UI)| None|
|Scope (S)| Unchanged|
|Confidentiality (C)| High|
|Integrity (I)| High|
|Availability (A)| High|

## 解決策、緩和策情報

## 影響を受けるソフトウェアとバージョン

Linux Kernel 4.5.1未満

## 技術的な詳細

 * [修正コミット](https://github.com/torvalds/linux/commit/34b88a68f26a75e4fded796f1a49c40f82234b7d)
 * [修正前の__sys_recvmmsg](https://github.com/torvalds/linux/blob/b6e4038262bc933f2ef5427b6bcd2607d02ba4bb/net/socket.c#L2169-L2272)
 * [修正後の__sys_recvmmsg](https://github.com/torvalds/linux/blob/34b88a68f26a75e4fded796f1a49c40f82234b7d/net/socket.c#L2169-L2272)

Use After
Freeの脆弱性であるなら、解放済み領域に値を書き込むようコードが存在するはずです。修正前のソースではその構造体に任意のアドレスを書く方法が存在し、修正後にはその方法がなくなっているはずです。
修正コミットには以下のように記述されてます。

```
And, as Dmitry rightly assessed, that is because we can drop the
reference and then touch it when the underlying recvmsg calls return
some packets and then hit an error, which will make recvmmsg to set
sock->sk->sk_err, oops, fix it.
```

gcc -Wall -std=c99 -Werror -pthread -static try_recvmmsg.c -o try_recvmmsg

### 検証環境の構築

```
kosuke@CVE-2016-7117 ~ $ uname -r
3.16.0-4-amd64
kosuke@CVE-2016-7117 ~ $ wget https://github.com/torvalds/linux/archive/v4.5-rc1.tar.gz
kosuke@CVE-2016-7117 ~ $ tar zxf v4.5-rc1.tar.gz
kosuke@CVE-2016-7117 ~ $ sudo ln -s /home/kosuke/linux-4.5-rc1/ /usr/src/linux
kosuke@CVE-2016-7117 ~ $ ls -l /usr/src/linux
lrwxrwxrwx 1 root root 27 10月 14 15:46 /usr/src/linux -> /home/kosuke/linux-4.5-rc1/
kosuke@CVE-2016-7117 ~ $ sudo cp /boot/config-3.16.0-4-amd64 /usr/src/linux/
wget https://github.com/torvalds/linux/archive/v4.5-rc1.tar.gz
kosuke@CVE-2016-7117 ~ $ uname -a
Linux CVE-2016-7117.test 3.2.0-4-amd64 #1 SMP Debian 3.2.68-1+deb7u2 x86_64 GNU/Linux
sudo apt-get install libncurses5-dev bc 
make defconfig
root@CVE-2016-7117:/boot/grub# uname -r
3.2.0-4-amd64
```

$ vagrant snapshot take pre_intall_kernel
Taking snapshot pre_intall_kernel
0%...10%...20%...30%...40%...50%...60%...70%...80%...90%...100%
Snapshot taken. UUID: 073cddda-ee48-43c8-8873-e930aca8ec96

```
kosuke@CVE-2016-7117 ~ $ uname -r
4.5.0-rc1
```



## 追跡が必要な情報源

 * [CERT](https://www.kb.cert.org/vuls/byid?query=CVE-2016-7117&searchview=)
 * [Debian](https://security-tracker.debian.org/tracker/CVE-2016-7117)
 * [Github](https://github.com/search?q="CVE-2016-7117")
 * [LWN](https://lwn.net/Search/DoSearch?words=CVE-2016-7117)
 * [NVD](https://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2016-7117)
 * [PacketStorm](https://packetstormsecurity.com/search/?q=CVE-2016-7117)
 * [Redhat](https://access.redhat.com/security/cve/CVE-2016-7117)
 * [Ubuntu](https://people.canonical.com/~ubuntu-security/cve/CVE-2016-7117.html)
 * [bugtraq](https://marc.info/?s=CVE-2016-7117&l=bugtraq)
 * [bugzilla](https://bugzilla.redhat.com/show_bug.cgi?id=CVE-2016-7117)
 * [centos](https://www.centos.org/forums/search.php?keywords=CVE-2016-7117)
 * [exploitdb](https://www.exploit-db.com/search/?action=search&cve=2016-7117)
 * [fulldisc](https://marc.info/?s=CVE-2016-7117&l=full-disclosure)
 * [metasploit](https://www.rapid7.com/db/search?q=CVE-2016-7117)
 * [oss-sec](https://marc.info/?s=CVE-2016-7117&l=oss-security)
 * [twitter](https://twitter.com/search?q=CVE-2016-7117)

# 参考文献

 * http://jvndb.jvn.jp/ja/contents/2016/JVNDB-2016-005186.html
 * https://blog.lizzie.io/notes-about-cve-2016-7117.html
 * http://qiita.com/kennygt51/items/bfd011fd2382fd1f0cba
 * http://d.hatena.ne.jp/jitsu102/20100325/1269458090


