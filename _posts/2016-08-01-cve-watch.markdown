---
layout: post
title:  "パッチ情報を通知してくれる何かが欲しいから作った"
date:   2016-08-01 19:00:00 +0900
categories: development
toc: true
---

脆弱性の評価を日常的に行っているんだけど、redhatやdebianからパッチが出るのは脆弱性の公表から数日ズレがある。
CVE番号を渡したら、対応するパッチ情報に更新があるかを調べて、更新がある時は通知してくれる簡単なツールがあれば便利だなと思った。
Go言語の学習がてら作ってみる。

# [cve_watch](https://github.com/KosukeShimofuji/cve_watch)

以下ようなのセキュリティアドバイザリのページを監視して、更新があれば通知を行う。

 * [redhat](https://access.redhat.com/security/cve/CVE-2016-5734)
 * [debian](https://security-tracker.debian.org/tracker/CVE-2016-5734)
 * [ubuntu](https://people.canonical.com/~ubuntu-security/cve/CVE-2016-5734.html)

redhatのパッチ情報のページは取得ごとにscriptタグ内部が変化するので、ここを考慮してhashを取る。

 * [get_site_hash](https://github.com/KosukeShimofuji/cve_watch/blob/master/research/get_site_hash.go)

```
$ go run get_site_hash.go
https://access.redhat.com/security/cve/CVE-2016-5734 : d909a58cc2e4284a3e45d29bb6ca8aea38ba1f1bd0eefc5ff5fc90d4f005198c
https://security-tracker.debian.org/tracker/CVE-2016-5734 : 3140054ee3f0deeca9de79fc2c3bf40a4c514441be86b1bc55959d52f96cbae9
https://people.canonical.com/~ubuntu-security/cve/CVE-2016-5734.html : 947c0895ed029945d3265d7b41a09c84dcb6e9e2098914711dcd124b97729307
$ go run get_site_hash.go
https://access.redhat.com/security/cve/CVE-2016-5734 : f546fcd8baebb69c9ffebd9f2dab0dd24555c2039914bfda78f8156487d0c4ef
https://security-tracker.debian.org/tracker/CVE-2016-5734 : 3140054ee3f0deeca9de79fc2c3bf40a4c514441be86b1bc55959d52f96cbae9
https://people.canonical.com/~ubuntu-security/cve/CVE-2016-5734.html : 947c0895ed029945d3265d7b41a09c84dcb6e9e2098914711dcd124b97729307
```

Last-Modifiedヘッダーも考えたが、提供しているのはubuntuのパッチ情報ページのみだった。

## Usage

 * トラッキングの開始

```
$ cve_watch add CVE-2016-5734
```

 * トラッキングの実行

```
$ cve_watch check
```

 * トラッキングの終了

```
$ cve_watch del CVE-2016-5734
```

 * トラッキング対象CVE一覧

```
$ cve_watch list
```

# Go言語の開発環境を構築

```
$ wget https://storage.googleapis.com/golang/go1.6.linux-amd64.tar.gz
$ sudo tar -C /usr/local -xzf go1.6.linux-amd64.tar.gz
$ mkdir $HOME/go
$ cat /etc/profile.d/goenv.sh
export GOROOT=/usr/local/go
export GOPATH=$HOME/go
export PATH=$PATH:$GOROOT/bin:$GOPATH/bin
$ source /etc/profile.d/goenv.sh
```

# GOのパッケージを作成

```
$ mkdir -p $GOPATH/src/github.com/KosukeShimofuji/cve_watch/
$ cd $GOPATH/src/github.com/KosukeShimofuji/cve_watch/
$ git init
Initialized empty Git repository in /home/kosuke/go/src/github.com/KosukeShimofuji/cve_watch/.git/
$ git remote add origin git@github.com:KosukeShimofuji/cve_watch.git
```

# 使ってみる

会社で常時動かているマシンに導入するのが都合が良さそうなのでそこにデプロイする。

 * x64 linux向けにビルドする

```
GOOS=linux GOARCH=amd64 go build main.go
```

 * 運用する環境にデプロイする

```
$ wget https://github.com/KosukeShimofuji/cve_watch/raw/master/release/cve_watch_linux_x64 -O cve_watch
$ chmod 700 cve_watch
```

 * 使う

```
$ ./cve_watch add CVE-2016-4971
$ ./cve_watch add CVE-2016-5734
$ ./cve_watch list
CVE_NUMBER      CREATED_AT
CVE-2016-4971   2016-08-01 18:58:38
CVE-2016-5734   2016-08-01 18:58:45
$ ./cve_watch check
```

想定通り動いたらslack通知を組み込んでcronから動作させれば、パッチ情報を見逃すことはなくなるかな。

# 参考文献

 * http://qiita.com/futoase/items/73b7ca9fb16ca588ad6f
 * https://developers.eure.jp/tech/golang_commandlinetool/
 * https://github.com/mattn/go-sqlite3/blob/master/_example/simple/simple.go
 * https://astaxie.gitbooks.io/build-web-application-with-golang/content/ja/07.3.html

